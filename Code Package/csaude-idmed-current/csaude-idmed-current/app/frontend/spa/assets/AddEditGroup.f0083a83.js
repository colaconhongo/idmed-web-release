import{Y as Te,b6 as Ve,r as n,i as T,cY as se,b8 as le,c as y,bg as Ee,d0 as ke,cK as Ne,o as Ce,w as Me,K as Ie,L as Qe,M as t,f as o,bd as Re,O as i,S as Oe,N as oe,P as G,R as V,U as E,bb as te,a8 as Be,V as h,a4 as b,a5 as k,a7 as N,bP as Ae,W as Ye,a$ as ze,D as q,c$ as z,z as S,bO as ie,B as Ue,C as Fe,b4 as $e,cg as Le,H as Je,d1 as je}from"./index.28c7e456.js";import{Q as U}from"./QSelect.caa108f8.js";import{Q as We,a as He}from"./QPopupProxy.bc9f6d75.js";import{Q as Ke}from"./QSpace.b53e3d44.js";import{Q as F}from"./QTooltip.f3ef7ac8.js";import{Q as re,a as ne,b as w}from"./QTable.f91943bc.js";import{C as Xe}from"./ClosePopup.20eb2e56.js";import{u as Ze}from"./patientMethods.cc912af0.js";const ea={class:"q-pa-md"},aa={class:"row items-center"},sa=i("span",{class:"q-pl-sm text-subtitle2"},"Dados do Grupo",-1),la={class:"q-mt-md"},oa={class:"row"},ta={class:"row q-mt-md"},ia={class:"row items-center justify-end"},ra={class:"q-mt-lg"},na={class:"row items-center q-mb-md"},ua=i("span",{class:"q-pl-sm text-subtitle2"},"Membros",-1),da={class:"row"},ca={class:"row q-mt-none"},pa={class:"col-6 q-pr-sm"},va=i("div",{class:"col text-center q-mb-lg text-subtitle1"}," Por Adicionar ",-1),ma={class:"full-width row flex-center text-primary q-gutter-sm text-body2"},fa=i("span",null," Sem resultados para visualizar ",-1),ga={class:"col"},ba={class:"col q-pl-sm"},_a=i("div",{class:"col text-center q-mb-lg text-subtitle1"}," Existentes ",-1),ya={class:"full-width row flex-center text-primary q-gutter-sm text-body2"},ha=i("span",null," Nenhum Paciente adicionado ",-1),Sa={class:"col"},Ca={__name:"AddEditGroup",emits:["close"],setup(wa,{emit:ue}){const $=[{name:"id",align:"left",label:"Identificador",sortable:!1},{name:"name",align:"left",label:"Nome",sortable:!1},{name:"options",align:"left",label:"Op\xE7\xF5es",sortable:!1}],{preferedIdentifier:L,fullName:J,hasEpisodes:Da}=Ze(),{alertSucess:j,alertError:c,alertInfo:Ga}=$e(),{closeLoading:p,showloading:C}=ze(),{isOnline:x}=Te(),de=ue,ce=Ve(),m=n("");n(""),n([]);const D=n([]),f=T("clinic"),pe=T("loadMemberInfoToShowByGroupId"),l=n(new se({id:le(),members:[]})),u=n(""),M=n(""),I=n(""),Q=T("step"),ve=y(()=>Ee.getAllClinicalServices()),me=y(()=>ke.getAllFromStorage()),fe=y(()=>Ne.getAllForGroupDispense()),W=y(()=>Q.value==="create"),H=y(()=>Q.value==="edit"),_=y(()=>Q.value==="addMember"),v=n(!1),R=n(null),O=n(null),B=n(null),A=n(null),Y=n(null),K=n(null),ge=T("getGroupMembers"),P=n(!0),X=()=>{l.value.service!==null&&l.value.dispenseType!==null?(M.value!==l.value.service.code&&(M.value=l.value.service.code),I.value!==l.value.service.code&&(I.value=l.value.dispenseType.code),P.value=!1,(M.value!==l.value.service.code||I.value!==l.value.service.code)&&l.value.members.length!==0&&(l.value.members=[],D.value=[])):P.value=!0},be=()=>{l.value.service!==null&&l.value.dispenseType!==null&&(P.value=!1)},_e=(s,a)=>{let e=!1;const r=Le.getAllFromStorage();return r!==null&&r.forEach(d=>{d.group=q.getGroupById(d.group_id),d.patient=S.getPatientByID(d.patient_id),s.id===d.patient.id&&a===d.group.service.code&&(d.endDate===null||d.endDate==="")&&(e=!0)}),e},ye=()=>{W.value||(l.value=q.getGroupWithsById(z.getItem("selectedGroupId")),l.value.members=l.value.members.filter(s=>s.endDate===null||s.endDate===""),l.value.members.map(s=>{s.patient=S.getPatienWithstByID(s.patient.id)}),p(),m.value=Se(l.value.startDate))},he=()=>{if(C(),x.value)u.value.length>0?(S.deletePatientStorage(s=>Ge(s)),S.apisearchByParam(u.value,f.value.id).then(s=>{const a=S.getPatientByClinicId(f.value.id);D.value=a.filter(e=>Z(e,u.value)||g(e.firstNames,u.value)||g(e.middleNames,u.value)||g(e.lastNames,u.value))})):p();else{const s=S.getPatientByClinicId(f.value.id);D.value=s.filter(a=>Z(a,u.value)||g(a.firstNames,u.value)||g(a.middleNames,u.value)||g(a.lastNames,u.value)),p()}},Z=(s,a)=>s.identifiers.length<=0?!1:s.identifiers.some(r=>g(r.value,a)),g=(s,a)=>a===""||s===null?!1:s.toLowerCase().includes(a.toLowerCase()),Se=s=>!s||!ie(s).isValid()?"":ie(s).format("DD-MM-YYYY"),we=()=>{l.value.members.forEach(s=>{s.patient.identifiers.forEach(a=>{a.episodes.forEach(e=>{x.value&&Je.apiGetAllByEpisodeId(e.id,0,500)})})})},De=s=>{const a=l.value.members.filter(e=>e.patient.id!==s.patient.id);l.value.members=a},Ge=s=>!l.value.members.some(e=>e.patient.id===s.id),ee=s=>new je({id:le(),startDate:ae(m.value),patient:s,clinic:f}),ae=s=>{const a=s.split("-");return new Date(+a[2],a[1]-1,+a[0])},qe=s=>{C(),l.value.members.some(e=>e.patient.id===s.id)?(p(),c("O paciente selecionado ja se encontra associado a este grupo ["+l.value.service.code+"].")):x.value?q.apiValidateBeforeAdd(s.id,l.value.service.code,l.value.dispenseType.code).then(e=>{e.data==="Accepted"?l.value.members.push(ee(s)):c(e.data),p()}):(s.identifiers.forEach(e=>{let r=null;e.service.code===l.value.service.code&&(r=Ue.lastEpisode(e.id),e.episodes=[],e.episodes.push(r),p(),!e.episodes.length>0?c("O paciente selecionado n\xE3o possui epis\xF3dios."):e.episodes[0].startStopReason.isStartReason||c("O \xDAltimo epis\xF3dio do paciente n\xE3o \xE9 de inicio"))}),Fe.getAllFromPatient(s.id).length===0&&c("error","O paciente selecionado n\xE3o possui visitas efectuadas."),_e(s,l.value.service.code)?c("O paciente selecionado ja se encontra associado a um grupo activo do servi\xE7o "):l.value.members.push(ee(s)),p())},xe=()=>{Pe()},Pe=async()=>{if(v.value=!0,R.value.validate(),O.value.validate(),A.value.validate(),K.value.validate(),B.value.validate(),Y.value.validate(),!R.value.hasError&&!O.value.hasError&&!A.value.hasError&&!B.value.hasError&&!Y.value.hasError){if(l.value.members.length===0)return v.value=!1,c("Por favor adicione membros ao grupo antes de gravar.");C(),setTimeout(()=>{p()},700),l.value.startDate=ae(m.value);const s=new se(JSON.parse(JSON.stringify(l.value)));s.clinic={},s.service={},s.groupType={},s.clinic.id=f.value.id,s.clinic_id=f.value.id,s.service.id=l.value.service.id,s.service_id=l.value.service.id,s.groupType.id=l.value.groupType.id,s.groupType_id=l.value.groupType.id,s.members.forEach(a=>{a.startDate=s.startDate,a.group_id=l.value.id;const e=a.patient.id;a.patient={},a.clinic={},a.group={},a.patient.id=e,a.patient_id=e,a.clinic_id=s.clinic.id,a.clinic.id=f.value.id,a.group.id=s.id,a.syncStatus="R"}),W.value?q.apiSave(s).then(a=>{v.value=!1,we(),j("Opera\xE7\xE3o efectuada com sucesso."),z.set("selectedGroupId",l.value.id),ce.push("/group/panel")}).catch(a=>{v.value=!1;const e=[];if(console.log(a),a.request.response!=null){const r=JSON.parse(a.request.response);r.total==null?e.push(r.message):r._embedded.errors.forEach(d=>{e.push(d.message)})}c("error",e)}):(s.packHeaders=[],q.apiUpdate(s).then(a=>{v.value=!1,x.value?pe():ge(),j("Opera\xE7\xE3o efectuada com sucesso."),de("close"),z.set("selectedGroupId",l.value.id)}).catch(a=>{v.value=!1;const e=[];if(console.log(a),a.request.response!=null){const r=JSON.parse(a.request.response);r.total==null?e.push(r.message):r._embedded.errors.forEach(d=>{e.push(d.message)})}c("error",e)}))}else v.value=!1};return Ce(()=>{ye(),be()}),Me(()=>D,(s,a)=>{s!==a&&p()}),(s,a)=>(Ie(),Qe(Ye,{style:{width:"900px","max-width":"90vw",height:"80%"}},{default:t(()=>[o(Re,{ratio:16/9,class:"col"},{default:t(()=>[i("form",{onSubmit:Oe(xe,["prevent"]),class:"q-ma-none"},[o(oe,{class:"q-pa-none bg-green-2"},{default:t(()=>[i("div",ea,[i("div",aa,[o(G,{name:"groups",size:"sm"}),sa])]),o(V,{color:"grey-13",size:"1px"})]),_:1}),o(oe,{class:"q-px-md"},{default:t(()=>[i("div",la,[i("div",oa,[o(U,{class:"col",ref_key:"curGroupServiceRef",ref:R,dense:"",disable:_.value||H.value,outlined:"",options:ve.value,modelValue:l.value.service,"onUpdate:modelValue":[a[0]||(a[0]=e=>l.value.service=e),a[1]||(a[1]=e=>X())],"option-value":"id","option-label":"code",label:"Servi\xE7o de Sa\xFAde *",rules:[e=>!!e||"Por favor indicar o Servi\xE7o de Sa\xFAde"]},null,8,["disable","options","modelValue","rules"]),o(E,{outlined:"",ref_key:"curGroupCodeRef",ref:O,modelValue:l.value.code,"onUpdate:modelValue":a[2]||(a[2]=e=>l.value.code=e),value:l.value.code,disable:_.value,type:"text","lazy-rules":"",label:"Numero do grupo *",dense:"",class:"col q-ml-md",rules:[e=>!!e||"Por favor indicar o Numero de Grupo"]},te({_:2},[l.value.code!==null&&l.value.code!==void 0&&l.value.code!==""?{name:"append",fn:t(()=>[]),key:"0"}:void 0]),1032,["modelValue","value","disable","rules"]),o(E,{outlined:"",ref_key:"curGroupNameRef",ref:B,modelValue:l.value.name,"onUpdate:modelValue":a[3]||(a[3]=e=>l.value.name=e),value:l.value.name,disable:_.value,type:"text","lazy-rules":"",label:"Nome *",dense:"",class:"col q-ml-md",rules:[e=>!!e||"Por favor indicar o Nome do Grupo"]},te({_:2},[l.value.name!==null&&l.value.name!==void 0&&l.value.name!==""?{name:"append",fn:t(()=>[]),key:"0"}:void 0]),1032,["modelValue","value","disable","rules"])]),i("div",ta,[o(U,{ref_key:"curGroupGroupTypeRef",ref:A,class:"col",dense:"",outlined:"",options:me.value,disable:_.value,modelValue:l.value.groupType,"onUpdate:modelValue":a[4]||(a[4]=e=>l.value.groupType=e),"option-value":"id","option-label":"description",label:"Tipo *",rules:[e=>!!e||"Por favor indicar o Tipo do Grupo"]},null,8,["options","disable","modelValue","rules"]),o(U,{class:"col q-ml-md",ref_key:"curGroupDispenseTypeRef",ref:K,dense:"",disable:_.value||H.value,outlined:"",options:fe.value,modelValue:l.value.dispenseType,"onUpdate:modelValue":[a[5]||(a[5]=e=>l.value.dispenseType=e),a[6]||(a[6]=e=>X())],"option-value":"id","option-label":"description",label:"Tipo de Dispensa *",rules:[e=>!!e||"Por favor indicar o Tipo de dispensa"]},null,8,["disable","options","modelValue","rules"]),o(E,{dense:"",outlined:"",class:"col q-ml-md",modelValue:m.value,"onUpdate:modelValue":a[8]||(a[8]=e=>m.value=e),disable:_.value,ref_key:"creationDateRef",ref:Y,label:"Data de Cria\xE7\xE3o *",rules:[e=>!!e||"Por favor indicar a Data de Cria\xE7\xE3o"]},{append:t(()=>[o(G,{name:"event",class:"cursor-pointer"},{default:t(()=>[o(We,{ref:"qDateProxy","transition-show":"scale","transition-hide":"scale"},{default:t(()=>[o(He,{modelValue:m.value,"onUpdate:modelValue":a[7]||(a[7]=e=>m.value=e),mask:"DD-MM-YYYY"},{default:t(()=>[i("div",ia,[Be(o(h,{label:"Close",color:"primary",flat:""},null,512),[[Xe]])])]),_:1},8,["modelValue"])]),_:1},512)]),_:1})]),_:1},8,["modelValue","disable","rules"]),o(Ke)])]),i("div",ra,[i("div",na,[o(G,{name:"person",size:"sm"}),ua]),o(V,{color:"grey-13",size:"1px"})]),i("div",da,[o(E,{"bottom-slots":"",outlined:"",modelValue:u.value,"onUpdate:modelValue":a[9]||(a[9]=e=>u.value=e),label:"Pesquisar por Identificador/Nome",style:{width:"400px"},disable:P.value,class:"q-mt-md",dense:""},{append:t(()=>[]),_:1},8,["modelValue","disable"]),o(h,{onClick:a[10]||(a[10]=e=>he()),class:"q-mt-md q-ml-md q-mb-md",square:"",color:"primary",icon:"search",disable:!1},{default:t(()=>[o(F,{class:"bg-green-5"},{default:t(()=>[b("Pesquisar")]),_:1})]),_:1})]),o(V,{color:"grey-13",size:"1px"}),i("div",ca,[i("div",pa,[va,o(re,{class:"col",dense:"",flat:"",rows:D.value,columns:$,"row-key":"id"},{"no-data":t(({icon:e,filter:r})=>[i("div",ma,[fa,o(G,{size:"2em",name:r?"filter_b_and_w":e},null,8,["name"])])]),body:t(e=>[o(ne,{props:e},{default:t(()=>[o(w,{key:"id",props:e},{default:t(()=>[b(k(N(L)(e.row).value),1)]),_:2},1032,["props"]),o(w,{key:"name",props:e},{default:t(()=>[b(k(N(J)(e.row)),1)]),_:2},1032,["props"]),o(w,{key:"options",props:e},{default:t(()=>[i("div",ga,[o(h,{flat:"",round:"",color:"primary",icon:"group_add",onClick:r=>qe(e.row)},{default:t(()=>[o(F,{class:"bg-primary"},{default:t(()=>[b("Adicionar")]),_:1})]),_:2},1032,["onClick"])])]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows"])]),o(V,{color:"grey-13 q-ma-none",vertical:"",inset:""}),i("div",ba,[_a,o(re,{class:"col",dense:"",flat:"",rows:l.value.members,columns:$,"row-key":"id"},{"no-data":t(({icon:e,filter:r})=>[i("div",ya,[ha,o(G,{size:"2em",name:r?"filter_b_and_w":e},null,8,["name"])])]),body:t(e=>[o(ne,{props:e},{default:t(()=>[o(w,{key:"id",props:e},{default:t(()=>[b(k(N(L)(e.row.patient).value),1)]),_:2},1032,["props"]),o(w,{key:"name",props:e},{default:t(()=>[b(k(N(J)(e.row.patient)),1)]),_:2},1032,["props"]),o(w,{key:"options",props:e},{default:t(()=>[i("div",Sa,[o(h,{flat:"",round:"",color:"red-8",icon:"group_remove",onClick:r=>De(e.row)},{default:t(()=>[o(F,{class:"bg-red-5"},{default:t(()=>[b("Remover")]),_:1})]),_:2},1032,["onClick"])])]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows"])])])]),_:1}),o(Ae,{align:"right",class:"fixed-card-actions"},{default:t(()=>[o(h,{label:"Cancelar",color:"red",onClick:a[11]||(a[11]=e=>s.$emit("close"))}),o(h,{type:"submit",label:"Gravar",color:"primary",loading:v.value},null,8,["loading"])]),_:1})],32)]),_:1})]),_:1}))}};export{Ca as _};
