import{bJ as Ie,dq as Se,Y as De,ce as de,r as _,o as _e,da as B,cf as Ve,$ as O,c as F,K as c,a_ as h,f as t,M as n,a4 as v,a5 as f,a8 as N,c8 as ce,O as i,P as Q,U as p,V as D,R as re,a9 as xe,a$ as he,be as we,dl as $,b8 as Ye,b4 as je,b6 as Ce,bO as M,b1 as I,cd as ee,a1 as me,a7 as ve,L as z,a6 as x,F as pe,c9 as fe}from"./index.28c7e456.js";import{Q as R,a as G}from"./QPopupProxy.bc9f6d75.js";import{Q as be}from"./QSpace.b53e3d44.js";import{Q as ye}from"./QScrollArea.288f8a37.js";import{C as W}from"./ClosePopup.20eb2e56.js";import{_ as Ae,u as Ne}from"./InvnetoryMethod.3c0c56e2.js";import{_ as qe}from"./TitleBar.f7be41e1.js";import{_ as ie}from"./ListHeader.c33af243.js";import{a as ge,c as P,b as T,Q as Ue}from"./QTable.f91943bc.js";import{S as Ee}from"./StockAlertService.3ee5a37f.js";import"./use-render-cache.3aae9b27.js";import"./QMenu.9a83401e.js";import"./position-engine.b3fa6cbd.js";import"./TouchPan.90ce57a2.js";import"./QSelect.caa108f8.js";import"./QList.d4521672.js";import"./QLinearProgress.c6927d78.js";import"./StockMethod.5d6dd1ce.js";const Pe=Ie(Se);function Me(){function H(b){return b.operation.code==="AJUSTE_POSETIVO"}function w(b){return b.operation.code==="AJUSTE_NEGATIVO"}function q(b,Y){return Pe.query().with("adjustedStock").with("inventory").with("clinic").with("operation").where("inventory_id",Y).where("adjusted_stock_id",b).first()}return{getInventoryStockAdjustmentById:q,isPosetiveAdjustment:H,isNegativeAdjustment:w}}const Te={class:"box-border q-pb-md"},Oe={class:"full-width row flex-center text-primary q-gutter-sm text-body2"},Fe=i("span",null," Sem resultados para visualizar ",-1),Qe={class:"row items-center justify-end"},Be={class:"row"},$e={class:"row"},ne=!0,ke={__name:"InventoryAdjustmentsContainer",props:["drugFromInventoryPanel","inventory"],setup(H){const{isOnline:w}=De(),q=H,{alertSucess:b,alertError:Y}=je(),{showloading:U,closeLoading:y}=he(),g=[{name:"order",required:!0,label:"Ordem",field:"index",align:"center",sortable:!1},{name:"batchNumber",align:"center",label:"Lote",sortable:!0},{name:"expireDate",align:"center",label:"Data de Validade",sortable:!1},{name:"currQty",align:"center",label:"Saldo Actual",sortable:!0},{name:"balance",align:"center",label:"Quantidade Contada",sortable:!0},{name:"notes",align:"center",label:"Notas",sortable:!1}],E=Me(),ue=we(),m=de(q.drugFromInventoryPanel),k=de(q.inventory),V=_({type:"",visible:!1,msg:""}),u=_([]),te=_(!1),C=_(0),A=_("display"),K=a=>{ne=!a};_e(()=>{U(),X()});const X=()=>{C.value=0,w.value||B.apiGetAllMobile(),Z()},Z=()=>{let a=1;const s=ae(m);C.value=s.length,s.length>0?(s.forEach(d=>{le(d,m,a),a=a+1}),y()):s.length===a&&y(),y()},ae=a=>(y(),Ve.getValidStockByDrug(a,O.currClinic().id)),le=(a,s,d)=>{let r=null;r=E.getInventoryStockAdjustmentById(a.id,k.id),r===null&&(r=new Se({id:null}),r.inventory=k,r.clinic=a.clinic,r.clinic_id=a.clinic_id,te.value=!0),r.index=d,r.adjustedStock=a,r.adjustedStock.auxExpireDate=ue.getDDMMYYYFromJSDate(r.adjustedStock.expireDate),r.adjustedStock.drug=s,r.adjustedStock.clinic={},r.adjustedStock.clinic.id=a.clinic_id,r.inventory={},r.inventory.id=k.id,k.adjustments.push(r),u.value.push(r)},oe=()=>{U();let a=0;u.value.forEach(s=>{if(s.adjustedStock.drug.id===m.id){a++;let d=null;Number(s.balance)>Number(s.adjustedStock.stockMoviment)?d=$.getStockOperatinTypeByCode("AJUSTE_POSETIVO"):Number(s.balance)<Number(s.adjustedStock.stockMoviment)?d=$.getStockOperatinTypeByCode("AJUSTE_NEGATIVO"):d=$.getStockOperatinTypeByCode("SEM_AJUSTE"),s.captureDate=new Date,s.operation=d,s.adjustedStock.clinic={},s.adjustedStock.clinic.id=s.clinic_id,s.inventory.clinic={},s.adjustedStock.drug={},s.adjustedStock.stock={},s.adjustedStock.stock.id=s.adjustedStock.stock_id,s.adjustedStock.drug.id=m.id,s.inventory={},s.inventory.id=k.id,E.isPosetiveAdjustment(s)?s.adjustedValue=Number(s.balance-s.adjustedStock.stockMoviment):E.isNegativeAdjustment(s)?s.adjustedValue=Number(s.adjustedStock.stockMoviment-s.balance):s.adjustedValue=0,se(s,a)}})},se=async(a,s)=>{a!==void 0?a.balance.length<=0||isNaN(a.balance)?(y(),Y("error","Por favor indicar um Numero Valido para o campo Quantidade Contada.")):(U(),s<=C.value&&(a.balance=Number(a.balance),a.id===null?(a.id=Ye(),await B.post(a).then(d=>{console.log("Post",d)})):await B.patch(a.id,a).then(d=>{console.log("patch",d)})),s===C.value&&(b("Opera\xE7\xE3o efectuada com sucesso."),A.value="display",y())):A.value="display"},L=()=>{A.value="edit"},J=F(()=>A.value==="edit"),S=F(()=>J.value?"bg-amber-9":"bg-primary");return(a,s)=>(c(),h("div",null,[t(ie,{addVisible:!1,doneVisible:J.value,onExpandLess:K,mainContainer:!1,onDone:oe,bgColor:S.value},{default:n(()=>[v(f(m.name)+" ("+f(m.packSize)+" "+f(m.form.description)+") ",1)]),_:1},8,["doneVisible","bgColor"]),N(i("div",Te,[t(Ue,{class:"col",dense:"",flat:"",rows:u.value,columns:g,"row-key":"id"},{"no-data":n(({icon:d,filter:r})=>[i("div",Oe,[Fe,t(Q,{size:"2em",name:r?"filter_b_and_w":d},null,8,["name"])])]),header:n(d=>[t(ge,{class:"text-left bg-grey-3",props:d},{default:n(()=>[t(P,{style:{width:"70px"}},{default:n(()=>[v(f(g[0].label),1)]),_:1}),t(P,{style:{width:"110px"}},{default:n(()=>[v(f(g[1].label),1)]),_:1}),t(P,{style:{width:"180px"}},{default:n(()=>[v(f(g[2].label),1)]),_:1}),t(P,{style:{width:"190px"}},{default:n(()=>[v(f(g[3].label),1)]),_:1}),t(P,{style:{width:"190px"}},{default:n(()=>[v(f(g[4].label),1)]),_:1}),t(P,{class:"col"},{default:n(()=>[v(f(g[5].label),1)]),_:1})]),_:2},1032,["props"])]),body:n(d=>[t(ge,{props:d},{default:n(()=>[t(T,{key:"order",props:d},{default:n(()=>[v(f(d.row.index),1)]),_:2},1032,["props"]),t(T,{key:"batchNumber",props:d},{default:n(()=>[t(p,{outlined:"",modelValue:d.row.adjustedStock.batchNumber,"onUpdate:modelValue":r=>d.row.adjustedStock.batchNumber=r,disable:"",label:"Lote",dense:"",class:"col"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["props"]),t(T,{key:"expireDate",props:d},{default:n(()=>[t(p,{dense:"",outlined:"",disable:"",class:"col",modelValue:d.row.adjustedStock.auxExpireDate,"onUpdate:modelValue":r=>d.row.adjustedStock.auxExpireDate=r,ref:"reOpenDate",label:"Data de Validade"},{append:n(()=>[t(Q,{name:"event",class:"cursor-pointer"},{default:n(()=>[t(R,{ref:"qDateProxy","transition-show":"scale","transition-hide":"scale"},{default:n(()=>[t(G,{modelValue:d.row.adjustedStock.auxExpireDate,"onUpdate:modelValue":r=>d.row.adjustedStock.auxExpireDate=r,mask:"DD-MM-YYYY"},{default:n(()=>[i("div",Qe,[N(t(D,{label:"Close",color:"primary",flat:""},null,512),[[W]])])]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1536)]),_:2},1024)]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1032,["props"]),t(T,{key:"currQty",props:d},{default:n(()=>[i("div",Be,[t(p,{dense:"",outlined:"",modelValue:d.row.adjustedStock.stockMoviment,"onUpdate:modelValue":r=>d.row.adjustedStock.stockMoviment=r,disable:"",label:"Quantidade",class:"col"},null,8,["modelValue","onUpdate:modelValue"])])]),_:2},1032,["props"]),t(T,{key:"balance",props:d},{default:n(()=>[i("div",$e,[t(p,{outlined:"",modelValue:d.row.balance,"onUpdate:modelValue":[r=>d.row.balance=r,s[0]||(s[0]=r=>L())],disable:!k.open,label:"Quantidade",dense:"",class:"col"},null,8,["modelValue","onUpdate:modelValue","disable"]),t(p,{outlined:"",modelValue:m.form.description,"onUpdate:modelValue":s[1]||(s[1]=r=>m.form.description=r),disable:"",label:"Forma",dense:"",class:"col q-ml-sm"},null,8,["modelValue"])])]),_:2},1032,["props"]),t(T,{key:"notes",props:d},{default:n(()=>[t(p,{outlined:"",modelValue:d.row.notes,"onUpdate:modelValue":[r=>d.row.notes=r,s[2]||(s[2]=r=>L())],disable:!k.open,label:"Notas",dense:"",class:"col"},null,8,["modelValue","onUpdate:modelValue","disable"])]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows"])],512),[[ce,ne]]),N(t(re,{color:"orange"},null,512),[[ce,!ne]]),t(xe,{modelValue:V.value.visible,"onUpdate:modelValue":s[3]||(s[3]=d=>V.value.visible=d),persistent:""},{default:n(()=>[t(Ae,{type:V.value.type,onCloseDialog:a.closeDialog},{title:n(()=>[v(" Informa\xE7\xE3o")]),msg:n(()=>[v(f(V.value.msg),1)]),_:1},8,["type","onCloseDialog"])]),_:1},8,["modelValue"])]))}};const Le={key:0,class:"row"},Je={class:"col-3 q-pa-md q-pl-lg q-ml-lg q-mr-lg",style:{"max-width":"500px"}},ze={class:"box-border q-pt-md"},Re={class:"row items-center justify-end"},Ge={class:"row items-center justify-end"},We={key:0,class:"row q-pa-sm"},He={class:"col q-pt-md q-mr-lg"},Ke={key:1,class:"row"},Xe={class:"col q-mx-md q-mt-md"},Ze={class:"box-border row q-pt-md"},et={class:"row items-center justify-end"},tt={class:"row items-center justify-end"},at={class:"row q-pa-sm"},lt={class:"col-12 q-px-md"},Vt={__name:"InventoryPanel",setup(H){const{isMobile:w}=De(),q=Ne(),b=Ce(),{closeLoading:Y,showloading:U}=he(),{alertSucess:y,alertWarningAction:g}=je(),E=Me(),{getDateFromHyphenYYYYMMDD:ue,getDateFromHyphenDDMMYYYY:m,getPreviousStatisticMonthsDateFromDate:k}=we(),V=de(_());_(!1),_(!1);const u=_(),te=_("Detalhes do Invent\xE1rio"),C={backgroundColor:"#ffffff",color:"#555"},A={backgroundColor:"#eee",color:"black"},K={right:"2px",borderRadius:"5px",backgroundColor:"#0ba58b",width:"5px",opacity:.75},X=()=>{b.go(-1)},Z=()=>{g("Nota: Ao encerrar o presente invent\xE1rio o stock ser\xE1 actualizado para os dados informados e est\xE1 opera\xE7\xE3o n\xE3o poder\xE1 ser desfeita. Continuar?","N\xE3o","Sim").then(l=>{l&&(U(),oe())})},ae=()=>{g("Nota: Deseja apagar o invent\xE1rio?","N\xE3o","Sim").then(l=>{l&&le()})},le=()=>{I.delete(a.value.id).then(async l=>{y("Opera\xE7\xE3o efectuada com sucesso."),b.go(-1)})},oe=async()=>{let l={};w.value?(l=I.getInvnetoryById(a.value.id),l.open=!1):l=await I.apiFetchByIdWeb(a.value.id),l.adjustments=a.value.adjustments;let o=!0;l.adjustments.length<=0||l.adjustments===null||l.adjustments===void 0?(l.adjustments=V.value.adjustments,o=!1):l.adjustments.length!==V.value.adjustments.length&&(l.adjustments=V.value.adjustments),l.adjustments.forEach(e=>{e.finalised=!0,e.id===null&&(e.id=Ye())}),se(l,o)},se=(l,o)=>{U(),o?L(l):J(0,l).then(()=>{L(l)})},L=l=>{w.value?(l.open=!1,l.endDate=M(m(u.value)).format("YYYY-MM-DD"),l.adjustments.forEach(o=>{o.inventory_id=l.id,o.finalised=!0;const e=o.adjustedStock;e.stockMoviment=o.balance,Ve.putMobile(e),B.putMobile(o)}),l.open=!1,I.putMobile(l).then(()=>{B.apiGetAllMobile(),Y(),y("Opera\xE7\xE3o efectuada com sucesso.")})):(l.open=!1,l.endDate=M(m(u.value)).format("YYYY-MM-DD"),I.apiClose(l.id,l.endDate).then(o=>{I.closeInventoryPinia(l,l.endDate),Ee.apiGetStockAlertAll(O.currClinic().id),Y(),y("Opera\xE7\xE3o efectuada com sucesso.")}))},J=async(l,o)=>{const e=o.adjustments[l];if(e!==void 0){let j=null;Number(e.balance)>Number(e.adjustedStock.stockMoviment)?j=$.getStockOperatinTypeByCode("AJUSTE_POSETIVO"):e.balance<e.adjustedStock.stockMoviment?j=$.getStockOperatinTypeByCode("AJUSTE_NEGATIVO"):j=$.getStockOperatinTypeByCode("SEM_AJUSTE"),e.captureDate=new Date,e.operation=j,e.clinic={},e.clinic.id=O.currClinic().id,e.adjustedStock.clinic={},e.adjustedStock.clinic.id=O.currClinic().id,e.inventory.clinic={},e.inventory={},e.inventory.id=o.id,e.inventory_id=o.id,e.adjusted_stock_id=e.adjustedStock.id,e.clinic_id=O.currClinic().id,e.finalised=!0,E.isPosetiveAdjustment(e)?(e.adjustedValue=Number(e.balance-e.adjustedStock.stockMoviment),e.adjustedStock.stockMoviment=e.adjustedStock.stockMoviment+e.adjustedValue):E.isNegativeAdjustment(e)?(e.adjustedValue=Number(e.adjustedStock.stockMoviment-e.balance),e.adjustedStock.stockMoviment=Number(e.adjustedStock.stockMoviment)-Number(e.adjustedValue)):e.adjustedValue=0,e!==void 0&&(e.balance.length<=0||isNaN(e.balance)?(Y(),alertError("error","Por favor indicar um Numero Valido para o campo Quantidade Contada.")):(console.log("Faz Post adjuste"),await B.post(e),l=l+1,await J(l,o)))}},S=F(()=>a.value!==null?M.utc(a.value.startDate).local().format("DD-MM-YYYY"):""),a=F(()=>I.getInvnetoryById(localStorage.getItem("currInventory")));_e(()=>{Y();const l=new Date;a.value.endDate!==null?u.value=M(a.value.endDate).format("DD-MM-YYYY"):s(l),V.value=a.value});const s=l=>{const o=new Date,e=new Date(k(o)[0].startDate),j=new Date(k(o)[0].endDate);return I.getInventoryInPreviousMonth(e,j)?(u.value=M(o).format("DD-MM-YYYY"),l===M(o).format("YYYY/MM/DD")):(u.value=M(j).format("DD-MM-YYYY"),l===M(j).format("YYYY/MM/DD"))},d=F(()=>{if(a.value!==null){if(!a.value.open){const l=[];return a.value.adjustments.forEach(o=>{l.push(o.adjustedStock.drug_id)}),ee.getDrugsFromListId(l)}if(a.value.generic==="true"||a.value.generic===!0)return ee.getDrugsWithValidStockInList(O.currClinic().id);if(localStorage.getItem("selectedDrugs")!==null&&localStorage.getItem("selectedDrugs")!==void 0){const l=localStorage.getItem("selectedDrugs").split(",");return ee.getDrugsFromListId(l)}else{const l=[];return a.value.adjustments.forEach(o=>{l.push(o.adjustedStock.drug_id)}),ee.getDrugsFromListId(l)}}else return[]}),r=F(()=>a.value!==null?q.getInventoryType(a.value):"");return me("title",te),me("currInventory",a),(l,o)=>(c(),h("div",null,[t(qe),ve(w)?x("",!0):(c(),h("div",Le,[i("div",Je,[i("div",null,[t(ie,{addVisible:!1,mainContainer:!0,bgColor:"bg-primary"},{default:n(()=>[v("Notas do Invent\xE1rio ")]),_:1}),i("div",ze,[t(p,{outlined:"",modelValue:r.value,"onUpdate:modelValue":o[0]||(o[0]=e=>r.value=e),label:"Tipo de Invent\xE1rio",disable:"",dense:"",class:"col q-ma-sm"},null,8,["modelValue"]),t(p,{dense:"",outlined:"",disable:"",class:"col q-ma-sm",modelValue:S.value,"onUpdate:modelValue":o[2]||(o[2]=e=>S.value=e),ref:"dateReceived",label:"Data de Abertura"},{append:n(()=>[t(Q,{name:"event",class:"cursor-pointer"},{default:n(()=>[t(R,{ref:"qDateProxy","transition-show":"scale","transition-hide":"scale"},{default:n(()=>[t(G,{modelValue:S.value,"onUpdate:modelValue":o[1]||(o[1]=e=>S.value=e),mask:"DD-MM-YYYY"},{default:n(()=>[i("div",Re,[N(t(D,{label:"Close",color:"primary",flat:""},null,512),[[W]])])]),_:1},8,["modelValue"])]),_:1},512)]),_:1})]),_:1},8,["modelValue"]),t(p,{dense:"",outlined:"",disable:"",class:"col q-ma-sm",modelValue:u.value,"onUpdate:modelValue":o[4]||(o[4]=e=>u.value=e),ref:"dataFecho",label:"Data de Fecho"},{append:n(()=>[t(Q,{name:"event",class:"cursor-pointer"},{default:n(()=>[t(R,{ref:"qEndDateProxy","transition-show":"scale","transition-hide":"scale"},{default:n(()=>[t(G,{modelValue:u.value,"onUpdate:modelValue":o[3]||(o[3]=e=>u.value=e),mask:"DD-MM-YYYY",options:s},{default:n(()=>[i("div",Ge,[N(t(D,{label:"Close",color:"primary",flat:""},null,512),[[W]])])]),_:1},8,["modelValue"])]),_:1},512)]),_:1})]),_:1},8,["modelValue"]),t(re,{class:"q-mx-sm"}),a.value!==null?(c(),h("div",We,[t(D,{unelevated:"",color:"blue",class:"col",label:"Voltar",onClick:X}),a.value!==null?(c(),z(be,{key:0})):x("",!0),a.value.open?(c(),z(D,{key:1,unelevated:"",color:"orange",class:"q-ml-md col",onClick:o[5]||(o[5]=e=>Z()),label:"Fechar Invent\xE1rio"})):x("",!0),a.value.open?(c(),z(D,{key:2,unelevated:"",color:"red",class:"q-ml-md col",onClick:o[6]||(o[6]=e=>ae()),label:"Remover"})):x("",!0)])):x("",!0)])])]),i("div",He,[t(ye,{"thumb-style":K,"content-style":C,"content-active-style":A,style:{height:"750px"},class:"q-pr-md"},{default:n(()=>[(c(!0),h(pe,null,fe(d.value,e=>(c(),h("span",{key:e.id},[t(ke,{drugFromInventoryPanel:e,inventory:a.value},null,8,["drugFromInventoryPanel","inventory"])]))),128))]),_:1})])])),ve(w)?(c(),h("div",Ke,[i("div",Xe,[i("div",null,[t(ie,{addVisible:!1,mainContainer:!0,bgColor:"bg-primary"},{default:n(()=>[v("Notas do Invent\xE1rio ")]),_:1}),i("div",Ze,[t(p,{outlined:"",modelValue:r.value,"onUpdate:modelValue":o[7]||(o[7]=e=>r.value=e),label:"Tipo de Invent\xE1rio",disable:"",dense:"",class:"col q-ma-sm"},null,8,["modelValue"]),t(p,{dense:"",outlined:"",disable:"",class:"col q-ma-sm",modelValue:S.value,"onUpdate:modelValue":o[9]||(o[9]=e=>S.value=e),ref:"dateReceived",label:"Data de Abertura"},{append:n(()=>[t(Q,{name:"event",class:"cursor-pointer"},{default:n(()=>[t(R,{ref:"qDateProxy","transition-show":"scale","transition-hide":"scale"},{default:n(()=>[t(G,{modelValue:S.value,"onUpdate:modelValue":o[8]||(o[8]=e=>S.value=e),mask:"DD-MM-YYYY"},{default:n(()=>[i("div",et,[N(t(D,{label:"Close",color:"primary",flat:""},null,512),[[W]])])]),_:1},8,["modelValue"])]),_:1},512)]),_:1})]),_:1},8,["modelValue"]),t(p,{dense:"",outlined:"",disable:"",class:"col q-ma-sm",modelValue:u.value,"onUpdate:modelValue":o[11]||(o[11]=e=>u.value=e),ref:"dataFecho",label:"Data de Fecho","lazy-rules":""},{append:n(()=>[t(Q,{name:"event",class:"cursor-pointer"},{default:n(()=>[t(R,{ref:"qEndDateProxy","transition-show":"scale","transition-hide":"scale"},{default:n(()=>[t(G,{modelValue:u.value,"onUpdate:modelValue":o[10]||(o[10]=e=>u.value=e),mask:"DD-MM-YYYY",options:s},{default:n(()=>[i("div",tt,[N(t(D,{label:"Close",color:"primary",flat:""},null,512),[[W]])])]),_:1},8,["modelValue"])]),_:1},512)]),_:1})]),_:1},8,["modelValue"]),t(re,{class:"q-mx-sm"}),i("div",at,[t(D,{unelevated:"",color:"blue",class:"col",size:"10px",label:"Voltar",onClick:X}),a.value.open?(c(),z(be,{key:0})):x("",!0),a.value.open?(c(),z(D,{key:1,unelevated:"",color:"red",class:"q-ml-md col",onClick:o[12]||(o[12]=e=>Z()),size:"10px",label:"Fechar Invent\xE1rio"})):x("",!0)])])])]),i("div",lt,[t(ye,{"thumb-style":K,"content-style":C,"content-active-style":A,style:{height:"750px"}},{default:n(()=>[(c(!0),h(pe,null,fe(d.value,e=>(c(),h("span",{key:e.id},[t(ke,{drugFromInventoryPanel:e,inventory:a.value},null,8,["drugFromInventoryPanel","inventory"])]))),128))]),_:1})])])):x("",!0)]))}};export{Vt as default};
