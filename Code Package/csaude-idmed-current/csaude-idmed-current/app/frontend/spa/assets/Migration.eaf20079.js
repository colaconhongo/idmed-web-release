import{bO as ae,bJ as se,d_ as le,bM as k,_ as ee,r as m,w as z,o as U,c as A,K as _,a_ as I,f as r,a7 as J,O as w,i as ne,V as q,L as P,M as v,N as ie,P as de,a5 as x,R as ce,a4 as E,W as ue,a$ as oe,$ as me,a1 as te,a6 as D,a9 as ge,b4 as pe}from"./index.28c7e456.js";import{R as W}from"./ReportService.c2f34a2e.js";import{e as fe,s as _e}from"./exceljs.min.c840c290.js";import{Q as L,a as ve,b as O}from"./QTable.f91943bc.js";import{q as X}from"./vue3-apexcharts.3aa27b40.js";import{_ as he}from"./TitleBar.f7be41e1.js";import"./StockAlertService.3ee5a37f.js";import"./StockMethod.5d6dd1ce.js";import"./QList.d4521672.js";import"./QSelect.caa108f8.js";import"./QMenu.9a83401e.js";import"./position-engine.b3fa6cbd.js";import"./QLinearProgress.c6927d78.js";const H="RelatorioDeMigracao",we="Relatorio de Migracao iDart/IDMED",ye=H.concat("_"+ae(new Date).format("DD-MM-YYYY"));var be={async downloadExcel(o,d,e,s){const n=s,u=this.createArrayOfArrayRow(n),a=new fe.exports.Workbook;a.creator="FGH",a.lastModifiedBy="FGH",a.created=new Date,a.modified=new Date,a.lastPrinted=new Date;const t=a.addWorksheet(H),g=t.getCell("A9"),f=t.getCell("A11"),l=t.getCell("B11"),h=t.getCell("C11"),p=t.getCell("D11"),y=t.getCell("E11"),S=t.getCell("F11"),R=t.getCell("A12"),C=t.getCell("B12"),B=t.getRow(15),V=t.getColumn("A"),Q=t.getColumn("B"),G=t.getColumn("C"),j=t.getColumn("D"),K=t.getColumn("E"),T=t.getColumn("F");g.alignment=B.alignment={vertical:"middle",horizontal:"center",wrapText:!0},R.alignment=h.alignment=f.alignment=y.alignment={vertical:"middle",horizontal:"left",wrapText:!1},g.border=R.border=p.border=h.border=C.border=f.border=l.border=y.border=S.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},g.value=we,C.value=e,l.value=o,p.value=d,S.value=ae(new Date).format("DD-MM-YYYY"),R.value="Unidade Sanit\xE1ria",h.value="Distrito",f.value="Prov\xEDncia",y.value="Data",t.mergeCells("A9:F10"),t.mergeCells("B12:F12"),B.height=30,V.width=30,Q.width=30,G.width=30,j.width=30,K.width=30,T.width=150,g.font=h.font=f.font=y.font=R.font={name:"Arial",family:2,size:11,italic:!1,bold:!0},t.addTable({name:H,ref:"A14",headerRow:!0,totalsRow:!1,style:{showRowStripes:!1},columns:[{name:"ORD",totalsRowLabel:"none",filterButton:!1},{name:"ENTIDADE (iDart)",totalsRowLabel:"Totals:",filterButton:!1},{name:"ID (iDart)",totalsRowFunction:"none",filterButton:!1},{name:"CODIGO DO ERRO",totalsRowLabel:"Totals:",filterButton:!1},{name:"ESTADO",totalsRowFunction:"none",filterButton:!1},{name:"DESCRICAO",totalsRowFunction:"none",filterButton:!1}],rows:u});const c=t.lastRow.number!==void 0?t.lastRow.number:0;for(let $=14;$<=c;$++)t.getRow($).eachCell({includeEmpty:!0},Y=>{Y.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},Y.alignment={vertical:"middle",horizontal:"center",wrapText:!0},$===14&&(Y.fill={type:"pattern",pattern:"solid",fgColor:{argb:"1fa37b"},bgColor:{argb:"1fa37b"}},Y.font={name:"Arial",color:{argb:"FFFFFFFF"},family:2,size:11,italic:!1,bold:!0})});const b=await a.xlsx.writeBuffer(),F="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",Z=".xlsx",re=new Blob([b],{type:F});_e(re,ye+Z)},createArrayOfArrayRow(o){const d=[];let e=1;for(const s in o){const n=[];n.push(e),n.push(o[s].sourceEntity),n.push(o[s].sourceId),n.push(o[s].errorCode),n.push(o[s].status),n.push(o[s].errorDescription),d.push(n),e+=1}return e=0,o=[],d}};const N=se(le);var M={async apiGetAll(){const o=await k().get("/migration");return N.save(o.data),console.log(o.data),o},async initMigration(){return await k().post("/migration/initMigration")},async apiFetchById(o){return await k().get(`/migration/${o}`)},async apiMigrationStatusIsFinished(){return await k().get("/migration/migrationStatusFinished")},async finishMigration(){return await k().post("/migration/migrationCompleted").then(o=>{const d=this.getFromStorageByCode("PATIENT_MIGRATION_STAGE");d.value="COMPLETED",N.save(d);const e=ee.getActiveDataMigration();return e.value=!1,ee.saveInStorage(e),o})},newInstanceEntity(){return N.getModel().$newInstance()},getAllFromStorage(){return N.all()},getFromStorageByCode(o){return N.where("code",o).first()}};const Ae={class:"column items-center"},Se={__name:"ParamsProgress",props:["data"],setup(o){const d=[{name:"total",align:"center",label:"Total",field:"total",sortable:!0},{name:"migrated",label:"Migrados",field:"migrated",sortable:!0},{name:"rejected",label:"Rejeitados",field:"rejected"}],e=o,s=m([{name:"series-1",data:[0]}]),n=m({chart:{height:350,type:"radialBar",offsetY:-10},plotOptions:{radialBar:{startAngle:-135,endAngle:135,dataLabels:{name:{fontSize:"16px",color:void 0,offsetY:120},value:{offsetY:76,fontSize:"22px",color:void 0,formatter:function(a){return a+"%"}}}}},fill:{type:"gradient",gradient:{shade:"dark",shadeIntensity:.15,inverseColors:!1,opacityFrom:1,opacityTo:1,stops:[0,50,65,91]}},stroke:{dashArray:4},labels:["Parametros"]});z(()=>e.data,(a,t)=>{console.log(a),s.value[0]=a.stage_progress.toFixed(2)}),U(()=>{console.log(s)});const u=A(()=>[{total:e.data!==null?e.data.total_records:0,migrated:e.data!==null?e.data.total_migrated:0,rejected:e.data!==null?e.data.total_rejcted:0}]);return(a,t)=>(_(),I("div",null,[r(J(X),{style:{"max-width":"100%"},height:"500",type:"radialBar",options:n.value,series:s.value},null,8,["options","series"]),w("div",Ae,[r(L,{flat:"",separator:"vertical",rows:u.value,columns:d,"row-key":"name","hide-bottom":""},null,8,["rows"])])]))}},Te={class:"column items-center"},Me={__name:"StockProgress",props:["data"],setup(o){const d=[{name:"total",align:"center",label:"Total",field:"total",sortable:!0},{name:"migrated",label:"Migrados",field:"migrated",sortable:!0},{name:"rejected",label:"Rejeitados",field:"rejected"}],e=o,s=m([{name:"series-1",data:[0]}]),n=m({chart:{height:350,type:"radialBar",offsetY:-10},plotOptions:{radialBar:{startAngle:-135,endAngle:135,dataLabels:{name:{fontSize:"16px",color:void 0,offsetY:120},value:{offsetY:76,fontSize:"22px",color:void 0,formatter:function(a){return a+"%"}}}}},fill:{type:"gradient",gradient:{shade:"dark",shadeIntensity:.15,inverseColors:!1,opacityFrom:1,opacityTo:1,stops:[0,50,65,91]}},stroke:{dashArray:4},labels:["Stock"]});z(()=>e.data,(a,t)=>{console.log(a),s.value[0]=a.stage_progress.toFixed(2)});const u=A(()=>[{total:e.data!==null?e.data.total_records:0,migrated:e.data!==null?e.data.total_migrated:0,rejected:e.data!==null?e.data.total_rejcted:0}]);return(a,t)=>(_(),I("div",null,[r(J(X),{style:{"max-width":"100%"},height:"500",type:"radialBar",options:n.value,series:s.value},null,8,["options","series"]),w("div",Te,[r(L,{flat:"",separator:"vertical",rows:u.value,columns:d,"row-key":"name","hide-bottom":""},null,8,["rows"])])]))}},Ie={class:"column items-center",style:{"margin-top":"250px"}},Re=w("div",{class:"q-mt-md text-weight-medium"},"Iniciar a migra\xE7\xE3o",-1),Ce={__name:"MigrationStart",setup(o){const d=ne("migrationStarted"),e=()=>{M.initMigration().then(s=>{d(!0)})};return(s,n)=>(_(),I("div",Ie,[r(q,{size:"50px",round:"",color:"primary",icon:"send",onClick:e}),Re]))}},xe={class:"column items-center"},De={__name:"PatientProgress",props:["data"],setup(o){const d=[{name:"total",align:"center",label:"Total",field:"total",sortable:!0},{name:"migrated",label:"Migrados",field:"migrated",sortable:!0},{name:"rejected",label:"Rejeitados",field:"rejected"}],e=o,s=m([{name:"series-1",data:[0]}]),n=m({chart:{height:350,type:"radialBar",offsetY:-10},plotOptions:{radialBar:{startAngle:-135,endAngle:135,dataLabels:{name:{fontSize:"16px",color:void 0,offsetY:120},value:{offsetY:76,fontSize:"22px",color:void 0,formatter:function(a){return a+"%"}}}}},fill:{type:"gradient",gradient:{shade:"dark",shadeIntensity:.15,inverseColors:!1,opacityFrom:1,opacityTo:1,stops:[0,50,65,91]}},stroke:{dashArray:4},labels:["Pacientes"]});z(()=>e.data,(a,t)=>{console.log(a),s.value[0]=a.stage_progress.toFixed(2)});const u=A(()=>[{total:e.data!==null?e.data.total_records:0,migrated:e.data!==null?e.data.total_migrated:0,rejected:e.data!==null?e.data.total_rejcted:0}]);return(a,t)=>(_(),I("div",null,[r(J(X),{style:{"max-width":"100%"},height:"500",type:"radialBar",options:n.value,series:s.value},null,8,["options","series"]),w("div",xe,[r(L,{flat:"",separator:"vertical",rows:u.value,columns:d,"row-key":"name","hide-bottom":""},null,8,["rows"])])]))}},Ee={class:"row items-center text-subtitle1 q-pa-md"},Fe={class:"text-bold text-grey-10 q-ml-sm"},ke={__name:"ProgressDetails",props:["stage"],setup(o){const d=[{name:"total",align:"center",label:"Total",field:"total_records",sortable:!0},{name:"migrated",label:"Migrados",field:"migrated",sortable:!0},{name:"rejected",label:"Rejeitados",field:"rejcted"},{name:"id",label:"Tipo de registo",field:"id"},{name:"migration_progress",label:"Progresso",field:"migration_progress"}],e=o,{closeLoading:s,showloading:n}=oe(),u=m([]),a=()=>{W.apiMigrationStatusDetails(e.stage).then(g=>{u.value=g.data,console.log(u),s()})};U(()=>{n(),a()});const t=A(()=>e.stage==="PATIENT_MIGRATION_STAGE"?"pacientes":e.stage==="STOCK_MIGRATION_STAGE"?"stock":e.stage==="PARAMS_MIGRATION_STAGE"?"params":"");return(g,f)=>(_(),P(ue,{style:{width:"900px","max-width":"90vw"}},{default:v(()=>[r(ie,{class:"q-pa-none bg-green-2"},{default:v(()=>[w("div",Ee,[r(de,{name:"report",size:"md",color:"primary"}),w("div",Fe," Detalhes do progresso da migra\xE7\xE3o de "+x(t.value),1)]),r(ce)]),_:1}),r(L,{flat:"",class:"q-my-lg q-mx-md",separator:"horizontal",rows:u.value,columns:d,"row-key":"name","hide-bottom":""},{body:v(l=>[r(ve,{props:l},{default:v(()=>[r(O,{key:"total",props:l},{default:v(()=>[E(x(l.row.total_records),1)]),_:2},1032,["props"]),r(O,{key:"migrated",props:l},{default:v(()=>[E(x(l.row.migrated),1)]),_:2},1032,["props"]),r(O,{key:"rejected",props:l},{default:v(()=>[E(x(l.row.rejcted),1)]),_:2},1032,["props"]),r(O,{key:"id",props:l},{default:v(()=>[E(x(l.row.id),1)]),_:2},1032,["props"]),r(O,{key:"migration_progress",props:l},{default:v(()=>[E(x(l.row.migration_progress.toFixed(2))+"% ",1)]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows"]),r(q,{unelevated:"",color:"red",label:"Fechar",onClick:f[0]||(f[0]=l=>g.$emit("close")),class:"float-right q-mr-md q-mb-md"})]),_:1}))}},Oe={"q-px-xl":""},Ne={key:1,class:"row q-mt-md"},Pe={class:"col"},Be={class:"col"},Ge={class:"col"},je={key:2,class:"column items-center"},$e={class:"row q-mt-xl"},tt={__name:"Migration",setup(o){const{alertSucess:d,alertInfo:e,alertError:s,alertWarningAction:n}=pe(),{closeLoading:u,showloading:a}=oe(),t=m([]),g=m(""),f=m(!1),l=m(null),h=m(null),p=m(null),y=m(null),S=m(""),R=()=>{a(),W.apiGetMigrationLogReport().then(i=>{if(!i.data[0])e("Nao existem Dados para este relatorio");else{const c=y.value.province.description,b=y.value.district.description,F=y.value.clinicName;be.downloadExcel(c,b,F,i.data),u()}})},C=()=>{W.apiMigrationStatus().then(i=>{t.value=i.data,V(),B(),S.value=null,G.value||(S.value="")})},B=async()=>{t.value.forEach(async i=>{if(i.migration_stage==="PATIENT_MIGRATION_STAGE"){p.value=i,console.log(p.value.stage_progress>97);const c=M.getFromStorageByCode("PATIENT_MIGRATION_STAGE");p.value.total_migrated!==0&&p.value.stage_progress>80&&p.value.stage_progress<100&&c.value!=="COMPLETED"&&(await M.apiMigrationStatusIsFinished()).data===!0&&n("Deseja Terminar A Migra\xE7\xE3o ?").then(F=>{F&&(a(),M.finishMigration().then(Z=>{u(),d("Opera\xE7\xE3o efectuada com sucesso.")}))})}})},V=()=>{t.value.forEach(i=>{i.migration_stage==="PATIENT_MIGRATION_STAGE"?(p.value=i,(p.value.total_migrated!==0||p.value.total_rejcted!==0)&&p.value.stage_progress<100&&(g.value="PATIENT_MIGRATION_STAGE")):i.migration_stage==="STOCK_MIGRATION_STAGE"?(h.value=i,(h.value.total_migrated!==0||h.value.total_rejcted!==0)&&h.value.stage_progress<100&&(g.value="STOCK_MIGRATION_STAGE")):i.migration_stage==="PARAMS_MIGRATION_STAGE"&&(l.value=i,(l.value.total_migrated!==0||l.value.total_rejcted!==0)&&l.value.stage_progress<100&&(g.value="PARAMS_MIGRATION_STAGE"))}),u()},Q=i=>{u(),M.apiGetAll(),C()};z(()=>S.value,(i,c)=>{G.value?(clearInterval(S),setInterval(()=>{C()},2*1e4)):clearInterval(S)}),A(()=>t);const G=A(()=>t.value.some(c=>c.stage_progress<100)),j=A(()=>t),K=A(()=>M.getAllFromStorage()),T=A(()=>K.value.some(c=>c.value!=="NOT_STARTED"));return U(()=>{y.value=me.currClinic(),a(),C(),M.apiGetAll()}),te("title",""),te("migrationStarted",Q),(i,c)=>(_(),I("div",Oe,[r(he,null,{default:v(()=>[E("Migra\xE7\xE3o de dados")]),_:1}),T.value?D("",!0):(_(),P(Ce,{key:0})),j.value&&T.value?(_(),I("div",Ne,[w("div",Pe,[T.value?(_(),P(Se,{key:0,data:l.value},null,8,["data"])):D("",!0)]),w("div",Be,[T.value?(_(),P(Me,{key:0,data:h.value},null,8,["data"])):D("",!0)]),w("div",Ge,[T.value?(_(),P(De,{key:0,data:p.value},null,8,["data"])):D("",!0)])])):D("",!0),j.value&&T.value?(_(),I("div",je,[w("div",$e,[r(q,{outline:"",rounded:"",color:"blue-9",label:"Imprimir relat\xF3rio de erros",onClick:c[0]||(c[0]=b=>R())}),r(q,{class:"q-ml-md",outline:"",rounded:"",color:"blue-9",label:"Ver detalhes do progresso",onClick:c[1]||(c[1]=b=>f.value=!0)})])])):D("",!0),r(ge,{persistent:"",modelValue:f.value,"onUpdate:modelValue":c[3]||(c[3]=b=>f.value=b)},{default:v(()=>[r(ke,{stage:g.value,onClose:c[2]||(c[2]=b=>f.value=!1)},null,8,["stage"])]),_:1},8,["modelValue"])]))}};export{tt as default};
