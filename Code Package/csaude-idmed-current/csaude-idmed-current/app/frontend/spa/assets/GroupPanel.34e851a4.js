import{Q as je}from"./QScrollArea.288f8a37.js";import{Q as Ut}from"./QDrawer.64b2d870.js";import{bJ as $t,cT as ft,bL as Qt,bM as oe,cU as et,Y as Fe,cV as _t,C as yt,z as qe,H as ct,J as qt,I as Xe,i as I,K as $,a_ as J,O as o,f as e,P as be,R as Ie,a5 as _,a7 as a,V as ee,be as rt,r as u,ca as bt,b8 as ke,o as ze,c as ve,bO as ye,a1 as y,L as te,M as r,N as Ke,a4 as h,F as ot,c9 as Gt,W as ut,bP as Yt,cW as Ot,cX as Ge,b4 as Ae,ce as tt,cY as Lt,w as Bt,cA as Ee,a6 as z,a9 as Oe,cg as it,B as Ne,cE as st,cf as Te,$ as Dt,cF as Rt,cB as pt,cd as Et,A as Ze,cZ as Ht,c_ as zt,a$ as nt,cy as We,cb as mt,S as Jt,U as kt,a8 as lt,b_ as gt,cN as ht,D as vt,c$ as at,b as Wt,bI as jt,cC as Xt,bg as Kt}from"./index.28c7e456.js";import{_ as Zt}from"./TitleBar.f7be41e1.js";import{_ as ei}from"./AddEditGroup.f0083a83.js";import{a as Le,b as Y,Q as Re}from"./QTable.f91943bc.js";import{Q as Me}from"./QTooltip.f3ef7ac8.js";import{_ as ti,u as X,b as Pe,c as Ue,d as ii}from"./AddEditPrescriptionUnit.262246ef.js";import{u as me}from"./patientMethods.cc912af0.js";import{_ as He}from"./ListHeader.c33af243.js";import{Q as si}from"./QExpansionItem.095ed3fd.js";import{Q as ai}from"./QList.d4521672.js";import{Q as wt,a as Mt}from"./QPopupProxy.bc9f6d75.js";import{Q as Pt}from"./QSelect.caa108f8.js";import{C as dt}from"./ClosePopup.20eb2e56.js";import"./TouchPan.90ce57a2.js";import"./position-engine.b3fa6cbd.js";import"./QSpace.b53e3d44.js";import"./QLinearProgress.c6927d78.js";import"./QMenu.9a83401e.js";import"./plugin-vue_export-helper.21dcd24c.js";import"./drugMethods.baae673f.js";import"./QSlideTransition.7e213459.js";import"./use-render-cache.3aae9b27.js";const $e=$t(ft),ri=Qt[ft.entity];var oi={post(n){return oe().post("groupPack",n).then(v=>{$e.save(v.data)})},get(n){if(n>=0)return oe().get("groupPack?offset="+n+"&max=100").then(v=>{$e.save(v.data),n=n+100,v.data.length>0&&this.get(n)})},patch(n,v){return oe().patch("groupPack/"+n,v).then(b=>{$e.save(b.data)})},delete(n){return oe().delete("groupPack/"+n).then(()=>{$e.destroy(n)})},async apiFetchById(n){return await oe().get(`/groupPack/${n}`)},async apiSave(n){return await oe().post("/groupPack",n)},async apiUpdate(n){return await oe().post("/groupPack",n)},newInstanceEntity(){return $e.getModel().$newInstance()},getAllFromStorage(){return $e.all()},getGroupPackByHeaderId(n){return $e.query().with("pack").where("header_id",n).get()},async getByIdFromDexie(n){return ri.get(n)}};const _e=$t(et),{isMobile:ni,isOnline:It}=Fe();var Qe={post(n){return oe().post("groupPackHeader",n).then(v=>{_e.save(v.data)})},get(n){if(n>=0)return oe().get("groupPackHeader?offset="+n+"&max=100").then(v=>{_e.save(v.data),n=n+100,v.data.length>0&&this.get(n)})},patch(n,v){return oe().patch("groupPackHeader/"+n,v).then(b=>{_e.save(b.data)})},delete(n){return oe().delete("groupPackHeader/"+n).then(()=>{_e.destroy(n)})},async apiFetchById(n){return await oe().get(`/groupPackHeader/${n}`).then(v=>(_e.save(v.data),v))},async apiSave(n){if(ni.value&&!It.value)n.syncStatus="R",await _t.nSQL(et.entity).query("upsert",n).exec(),console.log("criacaoGrupoPack"+n),n.groupPacks.forEach(v=>{console.log("criacaoVisitPack"+v.patientVisit),yt.saveInStorage(v.patientVisit),qe.putMobile(v.patientVisit)}),_e.save(n);else return await oe().post("/groupPackHeader",n).then(v=>(n.groupPacks.forEach(b=>{yt.saveInStorage(b.patientVisit)}),v))},async apiUpdate(n){return await oe().post("/groupPackHeader",n)},async apiDelete(n){if(It.value)return await oe().delete(`/groupPackHeader/${n.id}`).then(v=>{const b=oi.getGroupPackByHeaderId(n.id);console.log(b),b.forEach(m=>{const O=ct.getPatientVisitDetailsByPackId(m.pack_id),W=qt.getPackByID(m.pack_id),j=Xe.getPrescriptionByID(O.prescription_id);j.leftDuration=Number(W.weeksSupply/4),console.log(O)})});await _t.nSQL(et.entity).query("delete").where(["id","=",n.id]).exec()},newInstanceEntity(){return _e.getModel().$newInstance()},getAllFromStorage(){return _e.all()},getGroupPackHeaderByGroupId(n){return _e.query().withAllRecursive(3).where("group_id",n).orderBy("packDate","desc").get()}};function pe(){function n(b){return b.endDate!==null}function v(b){const m=[];return b.forEach(O=>{O.membershipEndDate!==null&&m.push(O)}),m}return{isDesintegrated:n,getActiveMemberRows:v}}const li={class:"text-center"},di={class:"q-mt-md"},ci=o("div",{class:"row items-center q-mb-sm"},[o("span",{class:"text-subtitle2"},"Detalhes do Grupo")],-1),ui={class:"row q-mb-sm"},pi=o("div",{class:"col-5 text-grey-9"},"Servi\xE7o Cl\xEDnico:",-1),mi={class:"col text-grey-10"},gi={class:"row q-mb-sm"},vi=o("div",{class:"col-5 text-grey-9"},"N\xFAmero:",-1),fi={class:"col text-grey-10"},bi={class:"row q-mb-sm"},Di=o("div",{class:"col-5 text-grey-9"},"Nome:",-1),_i={class:"col text-grey-10"},yi={class:"row q-mb-sm"},ki=o("div",{class:"col-5 text-grey-9"},"Tipo:",-1),hi={class:"col text-grey-10"},wi={class:"row q-mb-sm"},Mi=o("div",{class:"col-5 text-grey-9"},"Tipo de Dispensa:",-1),Pi={class:"col text-grey-10"},Ii={class:"row q-mb-sm"},xi=o("div",{class:"col-5 text-grey-9"},"Data In\xEDcio:",-1),Vi={class:"col text-grey-10"},Si={class:"row q-mb-sm"},$i=o("div",{class:"col-5 text-grey-9"},"Data Fim:",-1),qi={class:"col text-grey-10"},Gi={class:"row q-my-md"},Yi={class:"row"},xt={__name:"GroupInfo",emits:["editGroup","desintagrateGroup"],setup(n,{emit:v}){const{getDDMMYYYFromJSDate:b}=rt(),m=I("group");return(O,W)=>($(),J("div",null,[o("div",li,[e(be,{class:"profile iconColor",name:"groups",size:"190px"})]),o("div",di,[ci,e(Ie,{color:"grey-13",size:"1px",class:"q-mb-sm"})]),o("div",ui,[pi,o("div",mi,_(a(m).service.code),1)]),o("div",gi,[vi,o("div",fi,_(a(m).code),1)]),o("div",bi,[Di,o("div",_i,_(a(m).name),1)]),o("div",yi,[ki,o("div",hi,_(a(m).groupType.description),1)]),o("div",wi,[Mi,o("div",Pi,_(a(m).dispenseType!==null?a(m).dispenseType.description:""),1)]),o("div",Ii,[xi,o("div",Vi,_(a(b)(a(m).startDate)),1)]),o("div",Si,[$i,o("div",qi,_(a(m).endDate!==null&&a(m).endDate!==""?a(b)(a(m).endDate):"-"),1)]),e(Ie,{color:"grey-13",size:"1px",class:"q-mb-sm"}),o("div",Gi,[e(ee,{unelevated:"",color:"orange-5",label:"Editar",class:"col",onClick:W[0]||(W[0]=j=>O.$emit("editGroup")),disable:a(pe)().isDesintegrated(a(m))},null,8,["disable"])]),o("div",Yi,[e(ee,{unelevated:"",color:"primary",label:"Desintegrar",class:"col",onClick:W[1]||(W[1]=j=>O.$emit("desintagrateGroup")),disable:a(pe)().isDesintegrated(a(m))},null,8,["disable"])])]))}};function we(){function n(b){return b.endDate===null||b.endDate===""}function v(b){return b.membershipEndDate===null||b.membershipEndDate===""||b.membershipEndDate===void 0}return{isActive:n,isActiveView:v}}const Bi={class:"row items-center text-subtitle1 q-pa-md"},Ei={class:"text-bold text-grey-10 q-ml-sm"},Ni={class:"text-grey-10 q-ml-sm"},Fi=o("span",{class:"text-bold text-h6"},"|",-1),Ai={key:0,class:"text-grey-10 q-ml-sm"},Ci={class:"text-bold text-h6"},Ti={key:1,class:"text-grey-10 q-ml-sm"},Ui=o("span",{class:"text-bold text-h6"},"|",-1),Qi={class:"row q-mt-xl q-pt-md"},Oi={class:"text-right absolute-bottom q-mb-lg q-mr-md q-mt-xl no-pointer-events"},Nt={__name:"AddMemberPrescription",setup(n){const{idadeCalculator:v,getDDMMYYYFromJSDate:b,getDateFromHyphenDDMMYYYY:m,getYYYYMMDDFromJSDate:O}=rt(),{preferedIdentifierValue:W,fullName:j}=me(),{alertSucess:le,alertError:E,alertInfo:Q}=Ae();u("US_");const ne=u([]),L=u(!1),q=u(new bt({id:ke()})),{isOnline:G}=Fe(),M=I("patient"),F=I("isNewPrescription");I("showAddPrescription");const R=I("loadMemberInfoToShowByGroupId"),B=I("selectedMember"),w=I("loadedPrescriptionInfo"),de=I("getGroupMembers");ze(()=>{A()});const S=ve(()=>"Gravar"),A=()=>{F&&(q.value.visitDate=O(ye()),q.value.clinic=M.value.clinic,q.value.clinic_id=M.value.clinic_id,q.value.patient=M.value,q.value.patient_id=M.value.id,q.value.patientVisitDetails=[])},ie=()=>{G.value?R():de(!0)},K=()=>{L.value=!0,B.value.groupMemberPrescriptions=[];const d=new Ot({id:ke(),prescription:q.value.patientVisitDetails[0].prescription,member:B.value,used:!1}),Z=d.member.group.id,f=d.member.patient.id;d.member.group={},d.member.group.id=Z,d.member.group_id=Z,d.member.clinic={},d.member.clinic.id=M.value.clinic.id,d.member.clinic_id=M.value.clinic.id,d.member.patient={},d.member.patient.id=f;const se=d.prescription.doctor.id;d.prescription.doctor={},d.prescription.doctor.id=se,d.prescription.doctor_id=se,d.prescription.clinic={},d.prescription.clinic.id=d.member.clinic.id,d.prescription.clinic_id=d.member.clinic.id;const N=d.prescription.duration.id;d.prescription.duration={},d.prescription.duration.id=N,d.prescription.duration_id=N,d.prescription.prescribedDrugs.forEach(D=>{const ae=D.drug.id;D.drug={},D.drug.id=ae,D.drug.therapeuticRegimenList=[],D.drug.packaged_drugs=[]});const U=d.prescription.prescriptionDetails[0].therapeuticRegimen.id;d.prescription.prescriptionDetails[0].therapeuticRegimen={},d.prescription.prescriptionDetails[0].therapeuticRegimen.id=U,G.value||(d.prescription.doctor_id=d.prescription.doctor.id,d.prescription.clinic_id=d.prescription.clinic.id,d.prescription.duration_id=d.prescription.duration.id,d.prescription.prescriptionDetails[0].prescription_id=d.prescription.id,d.prescription.prescriptionDetails[0].therapeutic_line_id=d.prescription.prescriptionDetails[0].therapeuticLine.id,d.prescription.prescriptionDetails[0].therapeutic_regimen_id=U,d.prescription.prescriptionDetails[0].dispense_type_id=d.prescription.prescriptionDetails[0].dispenseType.id,d.prescription.prescriptionDetails[0].spetialPrescriptionMotive!==null&&(d.prescription.prescriptionDetails[0].spetialPrescriptionMotive_id=d.prescription.prescriptionDetails[0].spetialPrescriptionMotive.id),d.prescription.prescribedDrugs.forEach(D=>{D.prescription_id=d.prescription.id,D.drug_id=D.drug.id}),d.syncStatus="R"),B.value.groupMemberPrescriptions[0]=d,Ge.apiSave(d).then(D=>{B.value.groupMemberPrescriptions[0]=d,console.log(B.value.groupMemberPrescription),ie(),le("Prescri\xE7\xE3o gravada com sucesso"),L.value=!1,w.value=!1}).catch(D=>{B.value.groupMemberPrescriptions[0]=null,L.value=!1,E("Ocorreu um erro ao gravar o prescri\xE7\xE3o do Membro")})};return y("curPatientVisit",q),y("selectedMember",B),(d,Z)=>($(),te(ut,{style:{width:"1350px","max-width":"110vw"}},{default:r(()=>[e(Ke,{style:{"max-height":"50vh"},class:"q-pa-none bg-green-2"},{default:r(()=>[o("div",Bi,[e(be,{name:a(M).gender=="Feminino"?"female":"male",size:"md",color:"primary"},null,8,["name"]),o("div",Ei,_(a(j)(a(M))),1),o("div",Ni,[Fi,h(" "+_(a(M).gender),1)]),a(v)(a(b)(a(M).dateOfBirth))<=14?($(),J("div",Ai,[o("span",Ci,[h(" | "),e(be,{name:"child_care"})]),h(" "+_(a(v)(a(b)(a(M).dateOfBirth)))+" Ano(s) de Idade ",1)])):($(),J("div",Ti,[Ui,h(" "+_(a(v)(a(b)(a(M).dateOfBirth)))+" Anos de Idade ",1)]))]),e(Ie)]),_:1}),e(je,{style:{height:"800px"},class:"q-pr-md"},{default:r(()=>[e(Ke,null,{default:r(()=>[e(ai,{bordered:""},{default:r(()=>[($(!0),J(ot,null,Gt(a(M).identifiers,f=>($(),te(si,{key:f.id,group:"somegroup",dense:"",label:"Prescri\xE7\xE3o "+f.service.code+" - "+f.identifierType.code+": "+f.value,"default-opened":f.service.code==="TARV","header-class":ne.value[f.service.code]?"bg-amber-9 text-white text-bold text-subtitle1 vertical-middle q-pl-md":"bg-primary text-white text-bold text-subtitle1 vertical-middle q-pl-md","expand-icon-class":"text-white",modelValue:ne.value[f.service.code],"onUpdate:modelValue":se=>ne.value[f.service.code]=se},{default:r(()=>[e(ut,null,{default:r(()=>[e(Ke,null,{default:r(()=>[e(He,{bgColor:"bg-grey-6"},{default:r(()=>[h("Informa\xE7\xE3o da Prescri\xE7\xE3o ")]),_:1}),e(ti,{identifier:f},null,8,["identifier"])]),_:2},1024)]),_:2},1024),e(Ie)]),_:2},1032,["label","default-opened","header-class","modelValue","onUpdate:modelValue"]))),128))]),_:1})]),_:1}),e(Yt,null,{default:r(()=>[o("div",Qi,[o("span",Oi,[e(ee,{label:"Cancelar",color:"red",class:"all-pointer-events",onClick:Z[0]||(Z[0]=f=>w.value=!1)}),e(ee,{label:S.value,loader:"",disable:q.value.patientVisitDetails.length===0,loading:L.value,onClick:Z[1]||(Z[1]=f=>K()),color:"primary",class:"q-ml-md all-pointer-events"},null,8,["label","disable","loading"])])])]),_:1})]),_:1})]),_:1}))}};const Li={key:0,class:"q-mb-md box-border"},Ri={class:"full-width row flex-center text-primary q-gutter-sm text-body2"},Hi=o("span",null," Nenhum Paciente adicionado ",-1),zi={class:"col"},Ji={key:1,class:"q-mb-md box-border"},Wi={class:"full-width row flex-center text-primary q-gutter-sm text-body2"},ji=o("span",null," Nenhum Paciente adicionado ",-1),Xi={class:"col"},Vt={__name:"GroupMembers",emits:["addMember","desintagrateGroup"],setup(n,{emit:v}){const b=[{name:"id",align:"left",label:"Identificador",sortable:!1},{name:"name",align:"left",label:"Nome",sortable:!1},{name:"lasPrescriptionDate",align:"left",label:"Data da \xDAltima Prescri\xE7\xE3o",sortable:!1},{name:"remainingTime",align:"left",label:"Validade",sortable:!1},{name:"lastDispenseDate",align:"left",label:"Data da \xDAltima Dispensa",sortable:!1},{name:"nextPickupDate",align:"left",label:"Data do Pr\xF3ximo Levantamento",sortable:!1},{name:"options",align:"left",label:"Op\xE7\xF5es",sortable:!1}],{alertSucess:m,alertError:O,alertInfo:W,alertWarningAction:j}=Ae(),{website:le,isDeskTop:E,isOnline:Q}=Fe();sessionStorage.getItem("user");const ne=I("clinic");tt(u(new Lt({members:[]})));const L=u(null),q=u(!1);u();const G=u(!0),M=I("allMembers"),F=I("members"),R=u([]),B=u(!0),w=u(""),de=u(),S=I("group"),A=I("desintagrateGroup"),ie=I("loadMemberInfoToShowByGroupId"),K=I("groupMembersNew");I("loadMemberInfoByMember2");const d=I("newPrescription"),Z=I("loadedPrescriptionInfo"),f=I("getGroupMembers");Bt(()=>G.value,(g,p)=>{});const se=v,N=()=>{se("addMember")},U=g=>{B.value=!g},D=async g=>{await Ge.apiFetchByMemberId(g.groupMemberId);const p=Ge.getGroupMemberPrescriptionByMemberId(g.groupMemberId);j("Confirma a remo\xE7\xE3o da Prescri\xE7\xE3o do Membro["+g.fullName+"?").then(i=>{i&&Ge.delete(p.id).then(T=>{ie()})})},ae=g=>{w.value="Confirma\xE7\xE3o da remo\xE7\xE3o do membro.",Q?(R.value=it.getMemberById(g.groupMemberId),pe().getActiveMemberRows(K.value).length===1?j("Nota: Ao remover este membro o grupo ser\xE1 desintegrado. Continuar?").then(p=>{p&&A()}):j("Confirma a remo\xE7\xE3o do membro ["+g.fullName+"], deste grupo?").then(p=>{p&&k()})):(R.value=g,F.value.length===1?j("Nota: Ao remover este membro o grupo ser\xE1 desintegrado. Continuar?").then(p=>{p&&A()}):j("Confirma a remo\xE7\xE3o do membro ["+me().fullName(g.patient)+"], deste grupo?").then(p=>{p&&k()}))},k=()=>{R.value.endDate=new Date;const g=Object.assign({},R.value);g.group={},g.group.id=g.group_id;const p=g.patient.id;g.patient={},g.patient.id=p,g.clinic={},g.clinic.id=ne.value.id,it.apiUpdate(g).then(i=>{Q||f(),ie(),m("Opera\xE7\xE3o efectuada com sucesso.")})},x=g=>ye(g).format("DD-MM-YYYY"),c=()=>(pe().isDesintegrated(S)&&(F.value=M.value),F.value.forEach(g=>{g.patient.identifiers!==void 0&&(g.patient.identifiers[0].episodes[0]=C(g.patient.identifiers[0].id),g.patient.identifiers[0].episodes[0]!==null&&X().lastVisit(g.patient.identifiers[0].episodes[0]).pack!==null&&(X().lastVisit(g.patient.identifiers[0].episodes[0]).pack=qt.getPackWithsByID(X().lastVisit(g.patient.identifiers[0].episodes[0]).pack.id)))}),Q?K.value:F.value),C=g=>Ne.getStartEpisodeByIdentifierId(g);ze(()=>{Q||f()}),ve(()=>G.value);const ge=ve({get(){return c()}});return ve(()=>Z.value),y("patient",L),y("loadMemberInfoToShowByGroupId",ie),y("isNewPrescription",de),y("selectedMember",R),y("showAddPrescription",q),(g,p)=>($(),J("div",null,[e(He,{addVisible:!a(pe)().isDesintegrated(a(S)),mainContainer:!0,addButtonActions:()=>N(),expandVisible:!0,onExpandLess:U,bgColor:"bg-primary"},{default:r(()=>[h("Membros do Grupo ")]),_:1},8,["addVisible","addButtonActions"]),o("span",null,[a(Q)?($(),J("div",Li,[e(Re,{class:"col",dense:"",flat:"",rows:ge.value,columns:b,"row-key":"id"},{"no-data":r(({icon:i,filter:T})=>[o("div",Ri,[Hi,e(be,{size:"2em",name:T?"filter_b_and_w":i},null,8,["name"])])]),body:r(i=>[e(Le,{props:i,style:Ee(a(we)().isActiveView(i.row)?" color: black":"color: red")},{default:r(()=>[e(Y,{key:"id",props:i},{default:r(()=>[h(_(i.row.NID),1)]),_:2},1032,["props"]),e(Y,{key:"name",props:i},{default:r(()=>[h(_(i.row.fullName),1)]),_:2},1032,["props"]),e(Y,{key:"lasPrescriptionDate",props:i},{default:r(()=>[h(_(x(i.row.lastPrescriptionDateMember!==void 0?i.row.lastPrescriptionDateMember:i.row.lastPrescriptionDate)),1)]),_:2},1032,["props"]),e(Y,{key:"remainingTime",props:i},{default:r(()=>[h(_(i.row.lastPrescriptionDateMember!==void 0?i.row.validadeNova:i.row.validade)+" mes(es) ",1)]),_:2},1032,["props"]),e(Y,{key:"lastDispenseDate",props:i},{default:r(()=>[h(_(x(i.row.lastPickupDate)),1)]),_:2},1032,["props"]),e(Y,{key:"nextPickupDate",props:i},{default:r(()=>[h(_(x(i.row.nextPickupDate)),1)]),_:2},1032,["props"]),e(Y,{key:"options",props:i},{default:r(()=>[o("div",zi,[e(ee,{flat:"",round:"",color:"blue-8",disable:a(pe)().isDesintegrated(a(S))||!a(we)().isActiveView(i.row)||i.row.validadeNova>0||i.row.validade>0,icon:"post_add",onClick:T=>a(d)(i.row.groupMemberId,i.row.patientServiceId,i.row.episodeId)},{default:r(()=>[e(Me,{class:"bg-blue-5"},{default:r(()=>[h("Nova Prescri\xE7\xE3o")]),_:1})]),_:2},1032,["disable","onClick"]),e(ee,{flat:"",round:"",disable:a(pe)().isDesintegrated(a(S))||!a(we)().isActiveView(i.row)||i.row.validadeNova===0&&i.row.validade===0,color:"red-8",icon:"delete",onClick:T=>D(i.row)},{default:r(()=>[e(Me,{class:"bg-red-5"},{default:r(()=>[h("Remover Prescri\xE7\xE3o")]),_:1})]),_:2},1032,["disable","onClick"]),e(ee,{flat:"",round:"",color:"red-8",disable:a(pe)().isDesintegrated(a(S))||!a(we)().isActiveView(i.row),icon:"group_remove",onClick:T=>ae(i.row)},{default:r(()=>[e(Me,{class:"bg-red-5"},{default:r(()=>[h("Remover do Grupo")]),_:1})]),_:2},1032,["disable","onClick"])])]),_:2},1032,["props"])]),_:2},1032,["props","style"])]),_:1},8,["rows"])])):z("",!0),a(Q)?z("",!0):($(),J("div",Ji,[e(Re,{class:"col",dense:"",flat:"",rows:ge.value,columns:b,"row-key":"id"},{"no-data":r(({icon:i,filter:T})=>[o("div",Wi,[ji,e(be,{size:"2em",name:T?"filter_b_and_w":i},null,8,["name"])])]),body:r(i=>[e(Le,{props:i},{default:r(()=>[e(Y,{key:"id",props:i},{default:r(()=>[h(_(a(me)().preferedIdentifier(i.row.patient).value),1)]),_:2},1032,["props"]),e(Y,{key:"name",props:i},{default:r(()=>[h(_(a(me)().fullName(i.row.patient)),1)]),_:2},1032,["props"]),e(Y,{key:"lasPrescriptionDate",props:i},{default:r(()=>[h(_(x(i.row.groupMemberPrescriptions[0]!==void 0&&i.row.groupMemberPrescriptions[0]!==null?i.row.groupMemberPrescriptions[0].prescription.prescriptionDate:a(X)().lastVisit(i.row.patient.identifiers[0].episodes[0]).prescription.prescriptionDate)),1)]),_:2},1032,["props"]),e(Y,{key:"remainingTime",props:i},{default:r(()=>[h(_(i.row.groupMemberPrescriptions[0]!==void 0&&i.row.groupMemberPrescriptions[0]!==null?a(Pe)().remainigDuration(i.row.groupMemberPrescriptions[0].prescription):a(X)().lastVisit(i.row.patient.identifiers[0].episodes[0]).prescription.leftDuration)+" mes(es) ",1)]),_:2},1032,["props"]),e(Y,{key:"lastDispenseDate",props:i},{default:r(()=>[h(_(a(Pe)().lastPackOnPrescription(a(X)().lastVisit(i.row.patient.identifiers[0].episodes[0]).prescription)!==null?x(a(Pe)().lastPackOnPrescription(a(X)().lastVisit(i.row.patient.identifiers[0].episodes[0]).prescription).pickupDate):"-"),1)]),_:2},1032,["props"]),e(Y,{key:"nextPickupDate",props:i},{default:r(()=>[h(_(a(Pe)().lastPackOnPrescription(a(X)().lastVisit(i.row.patient.identifiers[0].episodes[0]).prescription)!==null?x(a(Pe)().lastPackOnPrescription(a(X)().lastVisit(i.row.patient.identifiers[0].episodes[0]).prescription).nextPickUpDate):"-"),1)]),_:2},1032,["props"]),e(Y,{key:"options",props:i},{default:r(()=>[o("div",Xi,[e(ee,{flat:"",round:"",color:"blue-8",disable:a(pe)().isDesintegrated(a(S))||!a(we)().isActive(i.row),icon:"post_add",onClick:T=>a(d)(i.row,i.row.patient.identifiers[0])},{default:r(()=>[e(Me,{class:"bg-blue-5"},{default:r(()=>[h("Nova Prescri\xE7\xE3o")]),_:1})]),_:2},1032,["disable","onClick"]),e(ee,{flat:"",round:"",color:"red-8",disable:a(pe)().isDesintegrated(a(S))||!a(we)().isActive(i.row),icon:"group_remove",onClick:T=>ae(i.row)},{default:r(()=>[e(Me,{class:"bg-red-5"},{default:r(()=>[h("Remover do Grupo")]),_:1})]),_:2},1032,["disable","onClick"])])]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows"])]))]),e(Oe,{persistent:"",modelValue:q.value,"onUpdate:modelValue":p[1]||(p[1]=i=>q.value=i)},{default:r(()=>[e(Nt,{onClose:p[0]||(p[0]=i=>q.value=!1)})]),_:1},8,["modelValue"])]))}},Ki={key:0},Zi=o("span",{class:"text-bold text-subtitle1 vertical-middle q-pl-md"},"Medicamentos Prescritos",-1),es={key:1,class:"col"},ts={class:"full-width row flex-center text-primary q-gutter-sm text-body2"},is=o("span",null," Nenhum Medicamento Indicado ",-1),ss={class:"hidden"},as={class:"col"},rs=o("strong",null,[o("em",null," Medicamento sem stock ")],-1),os={__name:"AddMemberDispense",props:["member"],setup(n){const v=[{name:"order",align:"left",label:"Ordem",sortable:!1},{name:"drug",align:"left",label:"Medicamento",sortable:!1},{name:"packSize",align:"left",label:"Quantidade no Frasco",sortable:!1},{name:"form",align:"left",label:"Forma",sortable:!1},{name:"takeInstrucions",align:"left",label:"Instru\xE7\xE3o de Toma",sortable:!1},{name:"packs",align:"left",label:"N\xFAmero de Frascos",sortable:!1},{name:"options",align:"left",label:"Op\xE7\xF5es",sortable:!1}],b=[{name:"drug",align:"left",field:k=>k.drug.name,label:"Medicamento",sortable:!0},{name:"dosage",align:"left",field:k=>"Tomar "+k.amtPerTime+" "+k.drug.form.description+" "+k.timesPerDay+" vez(es) por "+k.form,label:"Toma",sortable:!1},{name:"packs",align:"center",style:"width: 20px",field:k=>getQtyPrescribed(k,curPrescription.value.duration.weeks)>0?getQtyPrescribed(k,curPrescription.value.duration.weeks):1,label:"Quantidade em (Frascos)",sortable:!1}],m=n,{alertSucess:O,alertError:W}=Ae(),{closeLoading:j,showloading:le}=nt();I("clinic");let E=tt(u(new st));const Q=u(!1),ne=u(!1),L=u(!1),q=I("group"),G=I("membersDispenses"),M=u(""),F=u(""),R=u(""),B=I("drugsDuration"),w=I("pickupDate"),de=u(!0),S=I("curGroupPackHeader"),A=u(0),ie=k=>{de.value=k},K=I("drugQuantities"),d=I("stockIndicator"),Z=async k=>(await f(k)?A.value=k.quantitySupplied:(A.value=-1,d.value=!1),A.value),f=async k=>{let x=!0;const c=K.get(k.drug.id);if(B.value!==""){const C=Ue().getQtyPrescribed(k,B.weeks);k.quantitySupplied=C,x=await Te.checkStockStatus(k.drug.id,w.value,c,Dt.currClinic().id,B.weeks)}return x},se=()=>{let k;if(m.member.endDate===null){m.member.groupMemberPrescriptions[0]!=null?k=m.member.groupMemberPrescriptions[0].prescription:k=X().lastVisit(m.member.patient.identifiers[0].episodes[0]).prescription;const x=new st({id:ke()}),c=new ft({id:ke()}),C=new Rt({id:ke()}),ge=new bt({id:ke(),patient:m.member.patient,clinic:m.member.patient.clinic});k.prescribedDrugs.forEach(g=>{const p=new pt;p.id=ke(),p.amtPerTime=g.amtPerTime,p.timesPerDay=g.timesPerDay,p.form=g.form,p.drug=Et.getDrugWith1ById(g.drug.id),p.quantitySupplied=g.prescribedQty,p.creationDate=new Date,K.has(g.drug.id)||K.set(g.drug.id,0);const i=K.get(g.drug.id);K.set(g.drug.id,i+g.prescribedQty),C.packagedDrugs.push(p)}),x.prescription=k,x.pack=C,x.clinic={},x.clinic.id=m.member.patient.clinic.id,x.episode=Ne.getEpisodeById(m.member.patient.identifiers[0].episodes[0].id),x.patientVisit=ge,C.syncStatus=m.member.patient.his_id.length>10?"R":"N",C.patientVisitDetails.push(x),G.value.set(m.member,C),c.pack=C,S.value.groupPacks.push(c),L.value=!0,setTimeout(()=>{j()},1e3)}},N=()=>{const k=G.value.get(m.member);M.value=Ze.curIdentifierById(m.member.patient.identifiers[0].id),F.value=Ht.getPrescriptionDetailByID(k.patientVisitDetails[0].prescription.prescriptionDetails[0].id),R.value=k.patientVisitDetails[0],Q.value=!0},U=k=>zt.getFormById(k),D=k=>{console.log(q);const x=G.value.get(m.member),c=x.packagedDrugs.filter(C=>C.drug.id!==k.drug.id);x.packagedDrugs=c,console.log(x)},ae=(k,x)=>{console.log(x),x=R,console.log(x);const c=G.value.get(m.member);c.packagedDrugs.some(ge=>ge.drug.id===k.drug.id)?W("O medicamento seleccionado n\xE3o pode ser adicionado, pois j\xE1 existe na lista a dispensar para o membro ["+me().fullName(m.member.patient)+"]"):(c.packagedDrugs.push(new pt(k)),console.log(c.packagedDrugs)),Q.value=!1};return ze(()=>{se()}),y("curIdentifier",M),y("curPrescriptionDetail",F),y("addPrescribedDrug",ae),y("showAddEditDrug",Q),(k,x)=>($(),J(ot,null,[e(He,{mainContainer:!0,expandVisible:!0,onExpand:ie,bgColor:"bg-primary"},{default:r(()=>[h(_(a(me)().preferedIdentifier(n.member.patient).value)+" - "+_(a(me)().fullName(n.member.patient)),1)]),_:1}),de.value?($(),J("div",Ki,[Zi,L.value?($(),te(Re,{key:0,flat:"",bordered:"",dense:"","hide-bottom":"",rows:n.member.groupMemberPrescriptions[0]!==void 0&&n.member.groupMemberPrescriptions[0]!==null?n.member.groupMemberPrescriptions[0].prescription!==void 0?n.member.groupMemberPrescriptions[0].prescription.prescribedDrugs:[]:a(X)().lastVisit(n.member.patient.identifiers[0].episodes[0]).prescription.prescribedDrugs,columns:b,"row-key":"id"},{body:r(c=>[e(Le,{"no-hover":"",props:c},{default:r(()=>[e(Y,{key:"drug",props:c},{default:r(()=>[h(_(c.row.drug.name),1)]),_:2},1032,["props"]),e(Y,{key:"dosage",props:c},{default:r(()=>[h(_("Tomar "+c.row.amtPerTime+" "+U(c.row.drug.form_id).description+" "+c.row.timesPerDay+" vez(es) por "+c.row.form),1)]),_:2},1032,["props"]),e(Y,{"auto-width":"",key:"packs",props:c},{default:r(()=>[h(_(a(Ue)().getQtyPrescribed(c.row,n.member.groupMemberPrescriptions[0]!==void 0&&n.member.groupMemberPrescriptions[0]!==null?n.member.groupMemberPrescriptions[0].prescription.duration.weeks:a(X)().lastVisit(n.member.patient.identifiers[0].episodes[0]).prescription.duration.weeks)>0?a(Ue)().getQtyPrescribed(c.row,n.member.groupMemberPrescriptions[0]!==void 0&&n.member.groupMemberPrescriptions[0]!==null?n.member.groupMemberPrescriptions[0].prescription.duration.weeks:a(X)().lastVisit(n.member.patient.identifiers[0].episodes[0]).prescription.duration.weeks):1),1)]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows"])):z("",!0),e(Ie,{color:"grey-13",size:"1px",class:"q-mb-sm"})])):z("",!0),de.value?($(),J("div",es,[e(He,{addVisible:!0,mainContainer:!0,addButtonActions:()=>N(),bgColor:"bg-primary"},null,8,["addButtonActions"]),L.value?($(),te(Re,{key:0,class:"col",dense:"",flat:"",rows:a(G).get(n.member)!==void 0?a(G).get(n.member).packagedDrugs:[],columns:v,"row-key":"id"},{"no-data":r(({icon:c,filter:C})=>[o("div",ts,[is,e(be,{size:"2em",name:C?"filter_b_and_w":c},null,8,["name"])])]),body:r(c=>[e(Le,{props:c},{default:r(()=>[o("div",ss,_(Z(c.row)),1),e(Y,{key:"order",props:c},null,8,["props"]),e(Y,{key:"drug",props:c,style:Ee(A.value===-1?"color: red":" color: black")},{default:r(()=>[h(_(c.row.drug.name),1)]),_:2},1032,["props","style"]),e(Y,{key:"packSize",props:c,style:Ee(A.value===-1?"color: red":" color: black")},{default:r(()=>[h(_(c.row.drug.packSize),1)]),_:2},1032,["props","style"]),e(Y,{key:"form",props:c,style:Ee(A.value===-1?"color: red":" color: black")},{default:r(()=>[h(_(c.row.drug.form.description),1)]),_:2},1032,["props","style"]),e(Y,{key:"takeInstrucions",props:c,style:Ee(A.value===-1?"color: red":" color: black")},{default:r(()=>[h(_(c.row.drug.defaultTreatment)+" - "+_(c.row.drug.defaultTimes)+"X por "+_(c.row.drug.defaultPeriodTreatment),1)]),_:2},1032,["props","style"]),e(Y,{key:"packs",props:c,style:Ee(A.value===-1?"color: red":" color: black")},{default:r(()=>[h(_(a(Ue)().getQtyPrescribed(c.row,a(B).weeks)),1)]),_:2},1032,["props","style"]),e(Y,{key:"options",props:c},{default:r(()=>[o("div",as,[e(ee,{flat:"",round:"",color:"red-8",icon:"delete",onClick:C=>D(c.row)},{default:r(()=>[e(Me,{class:"bg-red-5"},{default:r(()=>[h("Remover")]),_:1})]),_:2},1032,["onClick"]),A.value===-1?($(),te(ee,{key:0,flat:"",round:"",color:"red",icon:"info"},{default:r(()=>[e(Me,{class:"bg-red",offset:[10,10],"transition-show":"flip-right","transition-hide":"flip-left"},{default:r(()=>[rs]),_:1})]),_:1})):z("",!0)])]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows"])):z("",!0)])):z("",!0),e(Oe,{persistent:"",modelValue:Q.value,"onUpdate:modelValue":x[1]||(x[1]=c=>Q.value=c)},{default:r(()=>[e(ii,{visitDetails:a(E),hasTherapeuticalRegimen:ne.value,onClose:x[0]||(x[0]=c=>Q.value=!1)},null,8,["visitDetails","hasTherapeuticalRegimen"])]),_:1},8,["modelValue"])],64))}},ns={class:"row items-center text-subtitle1 q-pa-md"},ls={class:"text-bold text-grey-10 q-ml-sm"},ds={class:"text-grey-10 q-ml-sm"},cs=o("span",{class:"text-bold text-h6"},"|",-1),us={class:"text-grey-10 q-ml-sm"},ps=o("span",{class:"text-bold text-h6"},"|",-1),ms={class:"q-mx-lg"},gs={class:"q-mt-lg"},vs=o("div",{class:"row items-center q-mb-sm"},[o("span",{class:"text-subtitle2"},"Dispensa")],-1),fs={class:"row q-mt-md"},bs={class:"row items-center justify-end"},Ds={class:"row items-center justify-end"},_s={class:"q-mt-md"},ys=o("div",{class:"row items-center q-mb-sm"},[o("span",{class:"text-subtitle2"},"Membros")],-1),ks={key:0},hs={__name:"GroupDispense",setup(n){const{getDDMMYYYFromJSDate:v,getDateFromHyphenDDMMYYYY:b,getYYYYMMDDFromJSDate:m,getJSDateFromDDMMYYY:O,getDateFormatYYYYMMDDFromDDMMYYYY:W,extractHyphenDateFromDMYConvertYMD:j}=rt(),{alertSucess:le,alertError:E}=Ae(),{closeLoading:Q,showloading:ne}=nt(),{isOnline:L}=Fe(),{getQtyPrescribed:q}=Ue(),G=u(""),M=u(""),F=u(""),R=u(""),B=I("clinic");let w=tt(u(new et({id:ke()})));tt(u(new st));const de=u(!1);u(!1),u([]),u(!0);const S=I("group"),A=u(!1),ie=I("defaultPickUpDate"),K=u(new Map),d=u(""),Z=u("");u("");const f=u(!1),se=I("loadMemberInfoToShowByGroupId"),N=I("getGroupMembers"),U=I("showNewPackingForm");I("groupMembersNew");const D=new Map,ae=u(!0),k=()=>{ie!==void 0&&ie.value!==null&&(M.value=v(ie)),L.value||(Et.getAllDrugs(),We.getAllFromStorage(),mt.getAllFromStorage())},x=l=>l<=ye(new Date).format("YYYY/MM/DD"),c=()=>{const l=[];return S.value.packHeaders.length>0?S.value.packHeaders.forEach(s=>{l.push(new Date(S.value.packHeaders.nextPickUpDate))}):S.value.members.forEach(s=>{l.push(new Date(Pe().lastPackOnPrescription(X().lastVisit(s.patient.identifiers[0].episodes[0]).prescription).nextPickUpDate))}),new Date(Math.max.apply(null,l))},C=()=>{let l="Os seguintes pacientes possuem prescri\xE7\xF5es inv\xE1lidas [",s="";return S.value.members.forEach(t=>{let V=0;t.groupMemberPrescriptions[0]!==null&&(V=Pe().remainigDuration(t.groupMemberPrescriptions[0].prescription)),(X().lastVisit(t.patient.identifiers[0].episodes[0]).prescription.leftDuration<=0&&t.groupMemberPrescriptions[0]===null||V<=0)&&(s+=s===""?me().fullName(t.patient):", "+me().fullName(t.patient))}),s!==""?(l+=s+"]",l):null},ge=()=>{let l="A dura\xE7\xE3o das prescri\xE7\xF5es \xE9 menor em rela\xE7\xE3o a dura\xE7\xE3o que pretende dispensar para os seguintes pacientes: [",s="";return S.value.members.forEach(t=>{let V=0;t.groupMemberPrescriptions[0]!==null&&(V=Pe().remainigDurationInWeeks(t.groupMemberPrescriptions[0].prescription)),V<We.getDurationById(F.value.id).weeks&&(s+=s===""?me().fullName(t.patient):", "+me().fullName(t.patient))}),s!==""?(l+=s+"]",l):null},g=()=>{f.value=!0;const l=W(M),s=W(c()),t=W(G);let V=C();if(V=ge(),V!==null)E(V),f.value=!1;else if(M.value===""||M.value===void 0)E(V),f.value=!1;else if(j(M)>ye().format("YYYY-MM-DD"))E("A data da dispensa indicada \xE9 maior que a data da corrente."),f.value=!1;else if(ye(l).isBefore(s,"day"))E("A data da dispensa n\xE3o pode ser anterior a "+v(c())),f.value=!1;else if(F.value==="")E("Por favor, o per\xEDodo para o qual est\xE1 a efectuar a dispensa."),f.value=!1;else if(G.value===""||G.value===void 0)E("Por favor, indique a data do pr\xF3ximo levantamento."),f.value=!1;else if(ye(t).isBefore(l))E("A data do pr\xF3ximo levantamento n\xE3o pode ser anterior a data do levantamento."),f.value=!1;else if(R.value==="")E("Por favor indicar o modo de dispensa."),f.value=!1;else{const P=i(M);P!==null?(E(P),f.value=!1):he()}},p=()=>{L.value?se():N(!0)},i=l=>{let s="A data de levantamento n\xE3o pode ser menor que a data das ultimas prescri\xE7\xF5es dos pacientes : [",t="";return S.value.members.forEach(V=>{let P="";V.groupMemberPrescriptions[0]!==null?P=ye(V.groupMemberPrescriptions[0].prescription.prescriptionDate).format("YYYY-MM-DD"):P=X().lastVisit(V.patient.identifiers[0].episodes[0]).prescription.prescriptionDate;const H=ye(l.value,"DD-MM-YYYY").format("YYYY-MM-DD");ye(H).isBefore(P,"day")&&(t+=t===""?V.patient.fullName:", "+V.patient.fullName)}),t!==""?(s+=t+"]",s):null},T=(l,s)=>{S.value.members.forEach(t=>{let V;t.groupMemberPrescriptions[0]!=null?V=t.groupMemberPrescriptions[0].prescription.prescribedDrugs:V=X().lastVisit(t.patient.identifiers[0].episodes[0]).prescription.prescribedDrugs,V.some(H=>H.drug.id===l.drug.id&&t.patient.id===d.value.patient_id)?E("O medicamento seleccionado n\xE3o pode ser adicionado, pois j\xE1 existe na lista a dispensar para o membro ["+me().fullName(t.patient)+"]"):t.groupMemberPrescriptions[0]!=null&&t.patient.id===d.value.patient_id?(l.prescription_id=t.groupMemberPrescriptions[0].prescription.id,K.value.get(t).packagedDrugs.push(new pt(l))):(X().lastVisit(t.patient.identifiers[0].episodes[0]).prescription.id,t.groupMemberPrescriptions[0].prescription.id)}),de.value=!1},xe=async(l,s)=>{const t=q(s,l.weeksSupply),V=m(b(M.value));return await Te.checkStockStatus(s.drug.id,V,t,Dt.currClinic().id,l.weeksSupply)},De=async()=>{let l="";for(const s of w.value.groupPacks){s.pack.packDate=w.value.packDate,s.pack.pickupDate=w.value.packDate,s.pack.nextPickUpDate=w.value.nextPickUpDate,s.pack.weeksSupply=We.getDurationById(w.value.duration.id).weeks,s.pack.dispenseMode={},s.pack.dispenseMode.id=R.value.id,s.pack.clinic={},s.pack.clinic.id=B.value.id;for(const t of s.pack.packagedDrugs){const V=await xe(s.pack,t);await Te.getValidStockByDrugAndPickUpDateOnline(t.drug.id,s.pack.pickupDate);let P;V?(Te.getValidStockByDrugAndPickUpDate(t.drug.id,m(b(M.value))).filter(Ce=>new Date(Ce.expireDate)>new Date&&Ce.stockMoviment>0).forEach(Ce=>{P+=Ce.stockMoviment}),P<t.quantitySupplied&&(l+=l===""?t.drug.name:", "+t.drug.name)):l+=l===""?t.drug.name:", "+t.drug.name}if(l!=="")return l;Object.keys(s.pack.packagedDrugs).forEach(function(t){const V=[],P=[],H=s.pack.packagedDrugs[t];let Se=H.quantitySupplied;const fe=Te.getValidStockByDrugAndPickUpDate(H.drug.id,m(b(M.value))).filter(ue=>new Date(ue.expireDate)>new Date&&ue.stockMoviment>0);let ce=0;for(;Se>0;)if(fe[ce].stockMoviment>=Se){fe[ce].stockMoviment=Number(fe[ce].stockMoviment-Se),P.push(fe[ce]),Se=0;const ue=new ht({id:ke()});ue.drug={},ue.drug.id=H.drug.id,ue.stock={},ue.stock.id=fe[ce].id,ue.quantitySupplied=H.quantitySupplied,ue.creationDate=new Date,V.push(ue)}else{const ue=fe[ce].stockMoviment;qtyPrescribed=Number(qtyPrescribed-fe[ce].stockMoviment),fe[ce].stockMoviment=0,P.push(fe[ce]);const Be=new ht;Be.drug={},Be.drug.id=H.drug.id,Be.stock={},Be.stock.id=fe[ce].id,Be.quantitySupplied=ue,Be.creationDate=new Date,ce=ce+1}const Tt=H.drug.clinicalService.id;H.drug.clinicalService={},H.drug.clinicalService.id=Tt,H.drug.therapeuticRegimenList=[],H.packagedDrugStocks=V,s.pack.patientVisitDetails[0].patientVisit.visitDate=w.value.packDate}.bind(this))}return l},he=async()=>{ne(),Ve(),console.log(S.value.members),De().then(l=>{l!=null&&l.length>0?(E(l),f.value=!1,Q()):(ne(),re(w.value.groupPacks,0))})},re=(l,s)=>{if(L.value)if(l[s]!==null&&l[s]!==void 0){const t=Object.assign({},l[s].pack.patientVisitDetails[0].patientVisit);t.patientVisitDetails.push(l[s].pack.patientVisitDetails[0]),t.patientVisitDetails[0].patientVisit=null,l[s].pack.patientVisitDetails=[],l[s].pack.packagedDrugs.forEach(P=>{P.drug.stocks=[],P.drug.form.drugs=[],P.drug.therapeuticRegimenList=[],P.drug.clinicalService.drugs=[],P.drug.packagedDrugStocks=[],P.drug.packaged_drugs=[]}),t.patientVisitDetails[0].pack=l[s].pack,t.patientVisitDetails[0].prescription.prescribedDrugs.forEach(P=>{P.drug.therapeuticRegimenList=[],P.drug.packaged_drugs=[],P.drug.stocks=[]});const V=t.patient.id;t.patient={},t.patient.id=V,t.patientVisitDetails.forEach(P=>{const H=P.episode.id,Se=P.prescription.id;P.episode={},P.episode.id=H,P.prescription={},P.prescription.id=Se}),l[s].patientVisit=t,s=s+1,setTimeout(re(l,s),4)}else w.value.groupPacks.forEach(t=>{t.pack.patientVisitDetails=[],t.pack_id=t.pack.id}),Qe.apiSave(w.value).then(t=>{Qe.apiFetchById(w.value.id),Q(),f.value=!1,U.value=!1,A.value=!1,p(),le("Opera\xE7\xE3o efectuada com sucesso.")}).catch(t=>{f.value=!1;const V=[];if(console.log(t),t.request.response!=null){const P=JSON.parse(t.request.response);P.total==null?V.push(P.message):P._embedded.errors.forEach(H=>{V.push(H.message)})}E("error",V)});else if(l[s]!==null&&l[s]!==void 0){const t=l[s].pack.patientVisitDetails[0].patientVisit;t.patientVisitDetails.push(l[s].pack.patientVisitDetails[0]),t.patientVisitDetails[0].patientVisit=null,l[s].pack.patientVisitDetails=[],l[s].pack.dispenseMode_id=l[s].pack.dispenseMode.id,l[s].pack.clinic_id=l[s].pack.clinic.id,l[s].pack.packagedDrugs.forEach(V=>{V.pack_id=l[s].pack.id,V.drug_id=V.drug.id,V.packagedDrugStocks.forEach(P=>{P.pack_id=l[s].pack.id,P.drug_id=P.drug.id,P.packagedDrug_id=V.id})}),t.patientVisitDetails[0].pack=l[s].pack,t.patientVisitDetails[0].pack.packagedDrugs=[],t.clinic_id=t.clinic.id,t.patient_id=t.patient.id,t.patientVisitDetails[0].episode_id=t.patientVisitDetails[0].episode.id,t.patientVisitDetails[0].clinic_id=t.patientVisitDetails[0].clinic.id,t.patientVisitDetails[0].patient_visit_id=t.id,t.patientVisitDetails[0].prescription_id=t.patientVisitDetails[0].prescription.id,t.patientVisitDetails[0].pack_id=t.patientVisitDetails[0].pack.id,l[s].patientVisit=t,s=s+1,setTimeout(re(l,s),4)}else w.value=JSON.parse(JSON.stringify(w.value)),w.value.groupPacks.forEach(t=>{t.pack.patientVisitDetails=[],t.pack_id=t.pack.id,t.header_id=w.id,t.syncStatus="R"}),w.value.duration_id=w.value.duration.id,w.value.group_id=S.value.id,w.value.group=null,Qe.apiSave(w.value).then(t=>{le("Opera\xE7\xE3o efectuada com sucesso."),f.value=!1,U.value=!1,A.value=!1,p(),Q()})},Ve=()=>{w.value.group={},w.value.group.id=S.value.id,w.value.duration={},w.value.duration.id=F.value.id,w.value.packDate=O(M.value),w.value.nextPickUpDate=O(G.value)},Ye=()=>(S.value.members=S.value.members.filter(l=>we().isActive(l)),S.value.members.forEach(l=>{l.groupMemberPrescriptions[0]=Ge.getGroupMemberPrescriptionByMemberId(l.id),l.patient=qe.getPatienWithstByID(l.patient_id),l.patient.identifiers=l.patient.identifiers.filter(s=>s.service.id===S.value.service.id),l.patient.identifiers[0].episodes[0]=Ft(l.patient.identifiers[0].id)}),A.value=!0,S),Ft=l=>Ne.getStartEpisodeByIdentifierId(l),Je=()=>{if(gt.isValid(O(M.value))&&F.value!==""){const l=O(M.value);let s=parseInt(F.value.weeks/4*2);F.value.weeks<=1&&(s=0);const t=parseInt(F.value.weeks*7+s);G.value=v(gt.addToDate(l,{days:t}))}},At=ve(()=>We.getAllFromStorage()),Ct=ve(()=>mt.getAllFromStorage());return ze(()=>{Ye(),k()}),y("curIdentifier",d),y("curPrescriptionDetail",Z),y("addPrescribedDrug",T),y("drugsDuration",F),y("generatepacks",he),y("loadGroup",Ye),y("membersDispenses",K),y("curGroupPackHeader",w),y("pickupDate",M),y("stockIndicator",ae),y("drugQuantities",D),(l,s)=>($(),te(ut,{style:{width:"1250px","max-width":"100vw"}},{default:r(()=>[e(Ke,{class:"q-pa-none bg-green-2"},{default:r(()=>[o("div",ns,[e(be,{name:"groups",size:"md",color:"primary"}),o("div",ls," Grupo: "+_(a(S).code),1),o("div",ds,[cs,h(" "+_(a(S).name),1)]),o("div",us,[ps,h(" "+_(a(S).groupType.code),1)])]),e(Ie)]),_:1}),o("form",{onSubmit:Jt(g,["prevent"])},[o("div",ms,[o("div",gs,[vs,e(Ie,{color:"grey-13",size:"1px",class:"q-mb-sm"})]),o("div",fs,[e(kt,{dense:"",outlined:"","bg-color":"white",class:"col",modelValue:M.value,"onUpdate:modelValue":[s[2]||(s[2]=t=>M.value=t),s[3]||(s[3]=t=>Je())],label:"Data de Levantamento"},{append:r(()=>[e(be,{name:"event",class:"cursor-pointer"},{default:r(()=>[e(wt,{ref:"qDateProxy","transition-show":"scale","transition-hide":"scale"},{default:r(()=>[e(Mt,{modelValue:M.value,"onUpdate:modelValue":[s[0]||(s[0]=t=>M.value=t),s[1]||(s[1]=t=>Je())],mask:"DD-MM-YYYY",options:x},{default:r(()=>[o("div",bs,[lt(e(ee,{label:"Close",color:"primary",flat:""},null,512),[[dt]])])]),_:1},8,["modelValue"])]),_:1},512)]),_:1})]),_:1},8,["modelValue"]),e(Pt,{dense:"",class:"q-mx-sm col","bg-color":"white",outlined:"",onBlur:s[4]||(s[4]=t=>Je()),modelValue:F.value,"onUpdate:modelValue":s[5]||(s[5]=t=>F.value=t),options:At.value,"option-value":"id","option-label":"description",label:"Dispensa para"},null,8,["modelValue","options"]),e(kt,{outlined:"",dense:"",modelValue:G.value,"onUpdate:modelValue":[s[7]||(s[7]=t=>G.value=t),s[8]||(s[8]=t=>Je())],label:"Proximo Levantamento","bg-color":"white",class:"col",ref:"nextPickupDate"},{append:r(()=>[e(be,{name:"event",class:"cursor-pointer"},{default:r(()=>[e(wt,{ref:"qDateProxy","transition-show":"scale","transition-hide":"scale"},{default:r(()=>[e(Mt,{modelValue:G.value,"onUpdate:modelValue":s[6]||(s[6]=t=>G.value=t),mask:"DD-MM-YYYY"},{default:r(()=>[o("div",Ds,[lt(e(ee,{label:"Close",color:"primary",flat:""},null,512),[[dt]])])]),_:1},8,["modelValue"])]),_:1},512)]),_:1})]),_:1},8,["modelValue"]),e(Pt,{dense:"",class:"q-mx-sm col","bg-color":"white",outlined:"",modelValue:R.value,"onUpdate:modelValue":s[9]||(s[9]=t=>R.value=t),options:Ct.value,"option-value":"id","option-label":"description",label:"Modo de dispensa"},null,8,["modelValue","options"])]),o("span",null,[o("div",_s,[ys,e(Ie,{color:"grey-13",size:"1px",class:"q-mb-sm"})]),A.value?($(),J("span",ks,[($(!0),J(ot,null,Gt(a(S).members,t=>($(),J("span",{key:t.id},[A.value?($(),te(os,{key:0,member:t},null,8,["member"])):z("",!0)]))),128))])):z("",!0)])]),e(Yt,{align:"right",class:"q-mb-md q-mr-sm"},{default:r(()=>[lt(e(ee,{label:"Cancelar",color:"red",onClick:s[10]||(s[10]=t=>l.$emit("close"))},null,512),[[dt]]),e(ee,{type:"submit",disable:!ae.value,loading:f.value,label:"Dispensar",color:"primary"},null,8,["disable","loading"])]),_:1})],32)]),_:1}))}},ws={key:0,class:"q-mb-md box-border"},Ms={class:"full-width row flex-center text-primary q-gutter-sm text-body2"},Ps=o("span",null," Nenhuma dispensa efectuada ",-1),Is={class:"col"},St={__name:"GroupDispenses",setup(n){const v=[{name:"lastDispenseDate",align:"left",label:"Data da \xDAltima Dispensa",sortable:!1},{name:"nextPickupDate",align:"left",label:"Data do Pr\xF3ximo Levantamento",sortable:!1},{name:"duration",align:"left",label:"Per\xEDodo Dispensado",sortable:!1},{name:"pickUpDays",align:"left",label:"Dias de Levantamento",sortable:!1},{name:"options",align:"left",label:"Op\xE7\xF5es",sortable:!1}],{getDDMMYYYFromJSDate:b,getDateFromHyphenDDMMYYYY:m,getYYYYMMDDFromJSDate:O,getJSDateFromDDMMYYY:W,getDateFormatYYYYMMDDFromDDMMYYYY:j,extractHyphenDateFromDMYConvertYMD:le}=rt(),{isOnline:E}=Fe(),{alertSucess:Q,alertError:ne}=Ae(),L=u(!0);u([]);const q=I("showNewPackingForm"),G=I("dataFetchDone"),{closeLoading:M,showloading:F}=nt(),R=I("getGroupMembers"),B=u(null),w=I("loadAllMembersInfoByMember2"),de=I("groupMembersNew"),S=I("loadMemberInfoToShowByGroupId"),A=N=>{Qe.apiDelete(N),E.value?S():R(),Q("Opera\xE7\xE3o efectuada com sucesso.")},ie=async()=>{if(E.value){let N="Os Pacientes do Grupo n\xE3o possuem prescri\xE7\xF5es validas: ",U="";de.value.forEach(D=>{D.validade===0&&D.validadeNova===0&&D.membershipEndDate===void 0&&(U+=U===""?D.fullName:", "+D.fullName)}),U!==""?(N+=U,ne(N)):(F(),await w(),f.value[0]!==null&&f.value[0]!==void 0&&(B.value=f.value[0].nextPickUpDate),q.value=!0)}else f.value[0]!==null&&f.value[0]!==void 0&&(B.value=f.value[0].nextPickUpDate),q.value=!0},K=(N,U)=>gt.getDateDiff(N,U,"days"),d=N=>{L.value=!N},Z=()=>{const N=Qe.getGroupPackHeaderByGroupId(at.getItem("selectedGroupId"));return N.length>0&&(N[0].isLast=!0),N},f=ve(()=>Z()),se=ve(()=>vt.getGroupById(at.getItem("selectedGroupId")));return y(B,"defaultPickUpDate"),(N,U)=>($(),J(ot,null,[o("div",null,[e(He,{addVisible:!a(pe)().isDesintegrated(se.value),mainContainer:!0,expandVisible:!0,onExpandLess:d,addButtonActions:ie,bgColor:"bg-primary"},{default:r(()=>[h("Dispensas Efectuadas ")]),_:1},8,["addVisible"]),L.value?($(),J("div",ws,[e(Re,{class:"col",dense:"",flat:"",rows:f.value,columns:v,"row-key":"id"},{"no-data":r(({icon:D,filter:ae})=>[o("div",Ms,[Ps,e(be,{size:"2em",name:ae?"filter_b_and_w":D},null,8,["name"])])]),body:r(D=>[e(Le,{props:D},{default:r(()=>[e(Y,{key:"lastDispenseDate",props:D},{default:r(()=>[h(_(a(b)(D.row.packDate)),1)]),_:2},1032,["props"]),e(Y,{key:"nextPickupDate",props:D},{default:r(()=>[h(_(a(b)(D.row.nextPickUpDate)),1)]),_:2},1032,["props"]),e(Y,{key:"duration",props:D},{default:r(()=>[h(_(D.row.duration!==null?D.row.duration.weeks/4:"")+" mes(es) ",1)]),_:2},1032,["props"]),e(Y,{key:"pickUpDays",props:D},{default:r(()=>[h(" Passam "+_(K(new Date,D.row.packDate))+" dias ap\xF3s o \xFAltimo levantamento ",1)]),_:2},1032,["props"]),e(Y,{key:"options",props:D},{default:r(()=>[o("div",Is,[e(ee,{flat:"",round:"",disable:!D.row.isLast||!a(pe)().isDesintegrated(se.value),color:"red-8",icon:"delete",onClick:ae=>A(D.row)},{default:r(()=>[e(Me,{class:"bg-red-5"},{default:r(()=>[h("Remover")]),_:1})]),_:2},1032,["disable","onClick"])])]),_:2},1032,["props"])]),_:2},1032,["props"])]),_:1},8,["rows"])])):z("",!0)]),e(Oe,{persistent:"",modelValue:a(q),"onUpdate:modelValue":U[1]||(U[1]=D=>Wt(q)?q.value=D:null)},{default:r(()=>[a(G)?($(),te(hs,{key:0,onGetGroupMembers:a(R),onClose:U[0]||(U[0]=D=>q.value=!1)},null,8,["onGetGroupMembers"])):z("",!0)]),_:1},8,["modelValue"])],64))}},xs={class:"row q-mb-sm"},Vs={class:"col"},Ss={class:"row q-ml-lg"},$s={class:"col-3 q-mt-sm"},qs={class:"col q-pt-md"},Gs={class:"row q-mb-sm text-weight-bold text-h6 text-orange-7"},Ys={class:"row text-subtitle2 text-grey-9"},Bs={class:"text-subtitle2 text-primary"},Es={class:"col-5 text-center"},Ns={class:"q-mt-md q-pt-md text-subtitle1 text-grey-14"},Fs=o("div",{class:"col"},null,-1),As={__name:"PanelTitleBar",setup(n){const v=I("group");return(b,m)=>($(),J("div",xs,[o("div",Vs,[o("div",Ss,[o("div",$s,[e(ee,{outline:"",round:"",color:"primary",size:"xl",icon:"groups",onClick:m[0]||(m[0]=O=>b.$emit("showGroupDetails"))})]),o("div",qs,[o("div",Gs,_(a(v).name),1),o("div",Ys,[h(" Tipo: "),o("span",Bs,_(a(v).groupType.description),1)])])])]),o("div",Es,[o("div",Ns,[jt(b.$slots,"default")])]),Fs]))}};const Cs={key:2,class:"q-pa-md"},Ts={class:"q-pa-md q-gutter-sm"},Us={class:"row q-mt-md"},Qs={class:"col q-pa-md q-pl-lg q-ml-lg q-mr-lg panel"},Os={key:3},Ls={class:"row q-mt-md"},Rs={class:"col-3 q-pa-md q-pl-lg q-ml-lg q-mr-lg panel"},Hs={class:"col q-mr-lg"},ba={__name:"GroupPanel",setup(n){const{alertSucess:v}=Ae(),{closeLoading:b,showloading:m}=nt(),{isOnline:O,isMobile:W,website:j}=Fe(),le=u(null),E=u(!1),Q=u(!1),ne=u(!1),L=u(!1),q=u(!1),G=u(!1),M=u(null),F=u([]);u(0);const R=u([]),B=u([]),w=u(!1),de=u(),S=u(!1),A=u("Painel do Grupo"),ie={backgroundColor:"rgba(0,0,0,0.02)",color:"#555"},K={backgroundColor:"#eee",color:"black"},d={right:"2px",borderRadius:"5px",backgroundColor:"#0ba58b",width:"5px",opacity:.75},Z=()=>{G.value=!G.value},f=async()=>(B.value=await it.apiGetGroupMemberInfo(at.getItem("selectedGroupId")),E.value=!0,b(),B),se=async()=>{const p=B.value.map(async i=>{if(i.membershipEndDate===void 0){await qe.apiFetchById(i.patientId);const xe=(await Ze.apiFetchById(i.patientServiceId)).data,De=await Ne.apiFetchById(i.episodeId),he=await Ge.apiFetchByMemberId(i.groupMemberId);if(De.data){xe.episodes[0]=De.data;const re=xe.episodes[0],Ve=await ct.apiGetLastByEpisodeId(re.id);if(Ve.data){re.patientVisitDetails=[],re.patientVisitDetails[0]=Ve.data;const Ye=await Xe.apiFetchById(re.patientVisitDetails[0].prescription.id);re.patientVisitDetails[0].prescription=Ye.data,he.status===200&&await Xe.apiFetchById(he.data.prescription.id)}}}});await Promise.all(p)},N=async(p,i,T)=>{await qe.apiFetchById(p.patient_id);const De=(await Ze.apiFetchById(i)).data,he=await Ne.apiFetchById(T);if(he.data){De.episodes[0]=he.data;const re=De.episodes[0],Ve=await ct.apiGetLastByEpisodeId(re.id);if(Ve.data){re.patientVisitDetails=[],re.patientVisitDetails[0]=Ve.data;const Ye=await Xe.apiFetchById(re.patientVisitDetails[0].prescription.id);re.patientVisitDetails[0].prescription=Ye.data,b()}}},U=()=>{m(),O.value?(mt.apiGetAll(),f()):(c.value.members.forEach(p=>{Ge.apiFetchByMemberId(p.id)}),E.value=!0,b())};ze(()=>{U()});const D=async()=>{m(),await ae(),L.value="addMember",q.value=!0},ae=async()=>{const p=B.value.map(async i=>{await qe.apiFetchById(i.patientId)});await Promise.all(p)},k=async()=>{m(),await ae(),L.value="edit",q.value=!0},x=ve(()=>E.value),c=ve(()=>vt.getGroupWithsById(at.getItem("selectedGroupId"))),C=()=>{c.value.members=c.value.members.filter(p=>we().isActive(p)),c.value.members.forEach(p=>{p.syncStatus!=="R"&&(p.syncStatus="U"),p.endDate=new Date;const i=p.patient.id;p.patient={},p.patient.id=i,p.group=null,p.clinic=ge.value}),c.value.endDate=new Date,c.value.packHeaders=[],vt.apiUpdate(c.value).then(p=>{f(),v("Opera\xE7\xE3o efectuada com sucesso.")})};Bt(()=>E.value,(p,i)=>{});const ge=ve(()=>Dt.currClinic()),g=async(p,i,T)=>{m(),le.value=it.getMemberById(p),await N(le.value,i,T),M.value=qe.getPatienWithstByID(le.value.patient_id);const xe=Ze.getLatestIdentifierSlimByPatientId(le.value.patient.id),De=new st({patientVisit:new bt({visitDate:new Date,patient:qe.getPatientByID(M.value.id),clinic:c.value.clinic}),clinic:c.value.clinic,createPackLater:!0,prescription:new Xt,episode:Ne.getEpisodeById(xe.episodes[0].id)});de.value=De,c.value.service=Kt.getClinicalServicePersonalizedById(c.value.service.id),S.value=!0,w.value=!0};return y("title",A),y("step",L),y("group",c),y("patient",M),y("clinic",ge),y("selectedMember",le),y("showAddPrescription",Q),y("showNewPackingForm",ne),y("desintagrateGroup",C),y("dataFetchDone",x),y("loadMemberInfoToShowByGroupId",f),y("allMembers",F),y("members",R),y("groupMembersNew",B),y("groupMembersNew",B),y("loadMemberInfoByMember2",N),y("membersInfoLoaded",E),y("newPrescription",g),y("loadedPrescriptionInfo",w),y("isNewPrescription",S),y("loadAllMembersInfoByMember2",se),(p,i)=>($(),J("div",null,[a(W)?($(),te(As,{key:0,onShowGroupDetails:Z},{default:r(()=>[h(" Detalhe do Grupo ")]),_:1})):($(),te(Zt,{key:1})),a(W)?($(),J("div",Cs,[o("div",Ts,[e(Ut,{modelValue:G.value,"onUpdate:modelValue":i[0]||(i[0]=T=>G.value=T),width:500,breakpoint:500,overlay:"",bordered:"",behavior:"mobile"},{default:r(()=>[e(je,{class:"fit"},{default:r(()=>[o("div",Us,[o("div",Qs,[e(xt,{onEditGroup:k,onDesintagrateGroup:C})])])]),_:1})]),_:1},8,["modelValue"]),e(je,{style:{height:"565px"}},{default:r(()=>[x.value?($(),te(Vt,{key:0,onAddMember:D,onDesintagrateGroup:C})):z("",!0),x.value?($(),te(St,{key:1})):z("",!0)]),_:1})])])):z("",!0),a(j)?($(),J("span",Os,[o("div",Ls,[o("div",Rs,[x.value?($(),te(xt,{key:0,onEditGroup:k,onDesintagrateGroup:C})):z("",!0)]),o("div",Hs,[e(je,{"thumb-style":d,"content-style":ie,"content-active-style":K,style:{height:"700px"},class:"q-pa-md"},{default:r(()=>[o("span",null,[x.value?($(),te(Vt,{key:0,onAddMember:D,onDesintagrateGroup:C})):z("",!0),x.value?($(),te(St,{key:1})):z("",!0)])]),_:1})])])])):z("",!0),e(Oe,{persistent:"",modelValue:q.value,"onUpdate:modelValue":i[2]||(i[2]=T=>q.value=T)},{default:r(()=>[e(ei,{onClose:i[1]||(i[1]=T=>q.value=!1)})]),_:1},8,["modelValue"]),e(Oe,{persistent:"",modelValue:w.value,"onUpdate:modelValue":i[4]||(i[4]=T=>w.value=T)},{default:r(()=>[w.value?($(),te(Nt,{key:0,onClose:i[3]||(i[3]=T=>w.value=!1)})):z("",!0)]),_:1},8,["modelValue"])]))}};export{ba as default};
